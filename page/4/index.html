<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="孤独是人生的常态">
<meta property="og:type" content="website">
<meta property="og:title" content="Williny&#39;home">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Williny&#39;home">
<meta property="og:description" content="孤独是人生的常态">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="williny">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Williny'home</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Williny'home</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="williny"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">williny</p>
  <div class="site-description" itemprop="description">孤独是人生的常态</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">172</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/suchangche" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;suchangche" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:469478061@qq.com" title="E-Mail → mailto:469478061@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/11/Lua-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/11/Lua-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">Lua-结构循环与流程控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-11 14:02:53 / 修改时间：15:19:36" itemprop="dateCreated datePublished" datetime="2022-10-11T14:02:53+08:00">2022-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Lua/" itemprop="url" rel="index"><span itemprop="name">Lua</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="循环类型"><a href="#循环类型" class="headerlink" title="循环类型"></a>循环类型</h1><table>
<thead>
<tr>
<th>循环类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-while-loop.html" title="Lua while 循环">while 循环</a></td>
<td>在条件为 true 时，让程序重复地执行某些语句。执行语句前会先检查条件是否为 true。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-for-loop.html" title="Lua for 循环">for 循环</a></td>
<td>重复执行指定语句，重复次数可在 for 语句中控制。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-repeat-until-loop.html" title="repeat...until 循环">repeat…until</a></td>
<td>重复执行循环，直到指定的条件为真时为止</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-nested-loops.html" title="Lua 循环嵌套">循环嵌套</a></td>
<td>可以在循环内嵌套一个或多个循环语句（while do … end;for … do … end;repeat … until;）</td>
</tr>
</tbody></table>
<h2 id="While循环"><a href="#While循环" class="headerlink" title="While循环"></a>While循环</h2><p>Lua 编程语言中 while 循环语句在判断条件为 true 时会重复执行循环体语句。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>Lua 编程语言中 while 循环语法：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(condition)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   statements</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="number">10</span></span><br><span class="line"><span class="keyword">while</span>( a &lt; <span class="number">20</span> )</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 的值为:&quot;</span>, a)</span><br><span class="line">   a = a+<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>执行以上代码，输出结果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a 的值为:    <span class="number">10</span></span><br><span class="line">a 的值为:    <span class="number">11</span></span><br><span class="line">a 的值为:    <span class="number">12</span></span><br><span class="line">a 的值为:    <span class="number">13</span></span><br><span class="line">a 的值为:    <span class="number">14</span></span><br><span class="line">a 的值为:    <span class="number">15</span></span><br><span class="line">a 的值为:    <span class="number">16</span></span><br><span class="line">a 的值为:    <span class="number">17</span></span><br><span class="line">a 的值为:    <span class="number">18</span></span><br><span class="line">a 的值为:    <span class="number">19</span></span><br></pre></td></tr></table></figure>

<h2 id="for-循环"><a href="#for-循环" class="headerlink" title="for 循环"></a>for 循环</h2><p>Lua 编程语言中 for 循环语句可以重复执行指定语句，重复次数可在 for 语句中控制。</p>
<p>Lua 编程语言中 for语句有两大类：：</p>
<ul>
<li>数值for循环</li>
<li>泛型for循环</li>
</ul>
<h3 id="数值for循环"><a href="#数值for循环" class="headerlink" title="数值for循环"></a>数值for循环</h3><p>Lua 编程语言中数值 for 循环语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var=exp1,exp2,exp3 <span class="keyword">do</span>  </span><br><span class="line">    &lt;执行体&gt;  </span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<p>var 从 exp1 变化到 exp2，每次变化以 exp3 为步长递增 var，并执行一次 **”执行体”**。exp3 是可选的，如果不指定，默认为1。</p>
<h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,f(x) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">1</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>for的三个表达式在循环开始前一次性求值，以后不再进行求值。</p>
<p>比如上面的f(x)只会在循环开始前执行一次，其结果用在后面的循环中。</p>
<p>验证如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/<span class="keyword">local</span>/bin/lua  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(x)</span></span>  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;function&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> x*<span class="number">2</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,f(<span class="number">5</span>) <span class="keyword">do</span> <span class="built_in">print</span>(i)  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function">1</span></span><br><span class="line"><span class="function">2</span></span><br><span class="line"><span class="function">3</span></span><br><span class="line"><span class="function">4</span></span><br><span class="line"><span class="function">5</span></span><br><span class="line"><span class="function">6</span></span><br><span class="line"><span class="function">7</span></span><br><span class="line"><span class="function">8</span></span><br><span class="line"><span class="function">9</span></span><br><span class="line"><span class="function">10</span></span><br></pre></td></tr></table></figure>

<p>可以看到 函数f(x)只在循环开始前执行一次。</p>
<h3 id="泛型for循环"><a href="#泛型for循环" class="headerlink" title="泛型for循环"></a>泛型for循环</h3><p>泛型 for 循环通过一个迭代器函数来遍历所有值，类似 java 中的 foreach 语句。</p>
<p>Lua 编程语言中泛型 for 循环语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--打印数组a的所有值  </span></span><br><span class="line">a = &#123;<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, v)</span><br><span class="line"><span class="keyword">end</span> </span><br></pre></td></tr></table></figure>

<p>i是数组索引值，v是对应索引的数组元素值。ipairs是Lua提供的一个迭代器函数，用来迭代数组。</p>
<h4 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h4><p>循环数组 days：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/<span class="keyword">local</span>/bin/lua  </span><br><span class="line">days = &#123;<span class="string">&quot;Sunday&quot;</span>,<span class="string">&quot;Monday&quot;</span>,<span class="string">&quot;Tuesday&quot;</span>,<span class="string">&quot;Wednesday&quot;</span>,<span class="string">&quot;Thursday&quot;</span>,<span class="string">&quot;Friday&quot;</span>,<span class="string">&quot;Saturday&quot;</span>&#125;  </span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(days) <span class="keyword">do</span>  <span class="built_in">print</span>(v) <span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<p>以上实例输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Sunday</span><br><span class="line">Monday</span><br><span class="line">Tuesday</span><br><span class="line">Wednesday</span><br><span class="line">Thursday</span><br><span class="line">Friday</span><br><span class="line">Saturday</span><br></pre></td></tr></table></figure>

<h2 id="repeat…until-循环"><a href="#repeat…until-循环" class="headerlink" title="repeat…until 循环"></a>repeat…until 循环</h2><p>Lua 编程语言中 <strong>repeat…until</strong> 循环语句不同于 for 和 while循环，for 和 while 循环的条件语句在当前循环执行开始时判断，而 repeat…until 循环的条件语句在当前循环结束后判断。</p>
<h3 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h3><p>Lua 编程语言中 repeat…until 循环语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repeat</span></span><br><span class="line">   statements</span><br><span class="line"><span class="keyword">until</span>( condition )</span><br></pre></td></tr></table></figure>

<p>我们注意到循环条件判断语句（condition）在循环体末尾部分，所以在条件进行判断前循环体都会执行一次。</p>
<p>如果条件判断语句（condition）为 false，循环会重新开始执行，直到条件判断语句（condition）为 true 才会停止执行。</p>
<h3 id="实例-3"><a href="#实例-3" class="headerlink" title="实例"></a>实例</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 变量定义 --]</span></span><br><span class="line">a = <span class="number">10</span></span><br><span class="line"><span class="comment">--[ 执行循环 --]</span></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a的值为:&quot;</span>, a)</span><br><span class="line">   a = a + <span class="number">1</span></span><br><span class="line"><span class="keyword">until</span>( a &gt; <span class="number">15</span> )</span><br></pre></td></tr></table></figure>

<p>执行以上代码，程序输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a的值为:    <span class="number">10</span></span><br><span class="line">a的值为:    <span class="number">11</span></span><br><span class="line">a的值为:    <span class="number">12</span></span><br><span class="line">a的值为:    <span class="number">13</span></span><br><span class="line">a的值为:    <span class="number">14</span></span><br><span class="line">a的值为:    <span class="number">15</span></span><br></pre></td></tr></table></figure>

<h2 id="循环嵌套"><a href="#循环嵌套" class="headerlink" title="循环嵌套"></a>循环嵌套</h2><p>Lua 编程语言中允许循环中嵌入循环。以下实例演示了 Lua 循环嵌套的应用。</p>
<h3 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h3><p>Lua 编程语言中 <strong>for</strong> 循环嵌套语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> init,<span class="built_in">max</span>/<span class="built_in">min</span> value, increment</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="keyword">for</span> init,<span class="built_in">max</span>/<span class="built_in">min</span> value, increment</span><br><span class="line">   <span class="keyword">do</span></span><br><span class="line">      statements</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   statements</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Lua 编程语言中 <strong>while</strong> 循环嵌套语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(condition)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="keyword">while</span>(condition)</span><br><span class="line">   <span class="keyword">do</span></span><br><span class="line">      statements</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   statements</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Lua 编程语言中 <strong>repeat…until</strong> 循环嵌套语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">repeat</span></span><br><span class="line">   statements</span><br><span class="line">   <span class="keyword">repeat</span></span><br><span class="line">      statements</span><br><span class="line">   <span class="keyword">until</span>( condition )</span><br><span class="line"><span class="keyword">until</span>( condition )</span><br></pre></td></tr></table></figure>

<p>除了以上同类型循环嵌套外，我们还可以使用不同的循环类型来嵌套，如 for 循环体中嵌套 while 循环。</p>
<h3 id="实例-4"><a href="#实例-4" class="headerlink" title="实例"></a>实例</h3><p>以下实例使用了for循环嵌套:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">j =<span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">2</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">   <span class="keyword">for</span> j=<span class="number">2</span>,(i/j) , <span class="number">2</span> <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">not</span>(i%j))</span><br><span class="line">      <span class="keyword">then</span></span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">if</span>(j &gt; (i/j))<span class="keyword">then</span></span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&quot;i 的值为：&quot;</span>,i)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>以上代码执行结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i 的值为：    <span class="number">8</span></span><br><span class="line">i 的值为：    <span class="number">9</span></span><br><span class="line">i 的值为：    <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h1 id="循环控制语句"><a href="#循环控制语句" class="headerlink" title="循环控制语句"></a>循环控制语句</h1><p>循环控制语句用于控制程序的流程， 以实现程序的各种结构方式。</p>
<p>Lua 支持以下循环控制语句：</p>
<table>
<thead>
<tr>
<th>控制语句</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-break-statement.html" title="Lua break 语句">break 语句</a></td>
<td>退出当前循环或语句，并开始脚本执行紧接着的语句。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-goto.html" title="Lua break 语句">goto 语句</a></td>
<td>将程序的控制点转移到一个标签处。</td>
</tr>
</tbody></table>
<h2 id="break-语句"><a href="#break-语句" class="headerlink" title="break 语句"></a>break 语句</h2><p>Lua 编程语言 break 语句插入在循环体中，用于退出当前循环或语句，并开始脚本执行紧接着的语句。</p>
<p>如果你使用循环嵌套，break语句将停止最内层循环的执行，并开始执行的外层的循环语句。</p>
<h3 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h3><p>Lua 编程语言中 <strong>break</strong> 语句语法格式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="实例-5"><a href="#实例-5" class="headerlink" title="实例"></a>实例</h3><p>以下实例执行 while 循环，在变量 a 小于 20 时输出 a 的值，并在 a 大于 15 时终止执行循环：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 定义变量 --]</span></span><br><span class="line">a = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[ while 循环 --]</span></span><br><span class="line"><span class="keyword">while</span>( a &lt; <span class="number">20</span> )</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 的值为:&quot;</span>, a)</span><br><span class="line">   a=a+<span class="number">1</span></span><br><span class="line">   <span class="keyword">if</span>( a &gt; <span class="number">15</span>)</span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">      <span class="comment">--[ 使用 break 语句终止循环 --]</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>以上代码执行结果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a 的值为:    <span class="number">10</span></span><br><span class="line">a 的值为:    <span class="number">11</span></span><br><span class="line">a 的值为:    <span class="number">12</span></span><br><span class="line">a 的值为:    <span class="number">13</span></span><br><span class="line">a 的值为:    <span class="number">14</span></span><br><span class="line">a 的值为:    <span class="number">15</span></span><br></pre></td></tr></table></figure>

<h2 id="goto-语句"><a href="#goto-语句" class="headerlink" title="goto 语句"></a>goto 语句</h2><p>Lua 语言中的 goto 语句允许将控制流程无条件地转到被标记的语句处。</p>
<h3 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h3><p>语法格式如下所示：</p>
<p>注意：此处的Label就像是一个标签，我姑且将其看作是一个无参的函数，goto过去即可调用此标签</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">goto</span> Label</span><br></pre></td></tr></table></figure>

<p>Label 的格式为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:: Label ::</span><br></pre></td></tr></table></figure>

<p>以下实例在判断语句中使用 goto：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">::label:: <span class="built_in">print</span>(<span class="string">&quot;--- goto label ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">a = a+<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> a &lt; <span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">goto</span> label   <span class="comment">-- a 小于 3 的时候跳转到标签 label</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- goto label ---</span></span><br><span class="line"><span class="comment">--- goto label ---</span></span><br></pre></td></tr></table></figure>

<p>从输出结果可以看出，多输出了一次 **— goto label —**。</p>
<p>以下实例演示了可以在 lable 中设置多个语句：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line">::s1:: <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">print</span>(i)</span><br><span class="line">  i = i+<span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">if</span> i&gt;<span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">os</span>.<span class="built_in">exit</span>()   <span class="comment">-- i 大于 3 时退出</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">goto</span> s1</span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>有了 goto，我们可以实现 continue 的功能：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>, <span class="number">3</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> i &lt;= <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(i, <span class="string">&quot;yes continue&quot;</span>)</span><br><span class="line">        <span class="keyword">goto</span> continue</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">print</span>(i, <span class="string">&quot; no continue&quot;</span>)</span><br><span class="line">    ::continue::</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">[[i&#x27;m end]]</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>   yes continue</span><br><span class="line">i<span class="string">&#x27;m end</span></span><br><span class="line"><span class="string">2   yes continue</span></span><br><span class="line"><span class="string">i&#x27;</span>m <span class="keyword">end</span></span><br><span class="line"><span class="number">3</span>    no continue</span><br><span class="line">i<span class="string">&#x27;m end</span></span><br></pre></td></tr></table></figure>

<h1 id="无限循环"><a href="#无限循环" class="headerlink" title="无限循环"></a>无限循环</h1><p>在循环体中如果条件永远为 true 循环语句就会永远执行下去，以下以 while 循环为例：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>( <span class="literal">true</span> )</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;循环将永远执行下去&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><p>Lua 编程语言流程控制语句通过程序设定一个或多个条件语句来设定。在条件为 true 时执行指定程序代码，在条件为 false 时执行其他指定代码。</p>
<p>说白了就是if语句</p>
<p>控制结构的条件表达式结果可以是任何值，Lua认为false和nil为假，true和非nil为真。</p>
<p>要注意的是Lua中 0 为 true：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 0 为 true ]</span></span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;0 为 true&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="if语句"><a href="#if语句" class="headerlink" title="if语句"></a>if语句</h2><h3 id="语法-5"><a href="#语法-5" class="headerlink" title="语法"></a>语法</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(布尔表达式)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式为 true 时执行的语句 --]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="实例-6"><a href="#实例-6" class="headerlink" title="实例"></a>实例</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 定义变量 --]</span></span><br><span class="line">a = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--[ 使用 if 语句 --]</span></span><br><span class="line"><span class="keyword">if</span>( a &lt; <span class="number">20</span> )</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ if 条件为 true 时打印以下信息 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 小于 20&quot;</span> );</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a 的值为:&quot;</span>, a);</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a 小于 <span class="number">20</span></span><br><span class="line">a 的值为:    <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h2 id="if…else-语句"><a href="#if…else-语句" class="headerlink" title="if…else 语句"></a>if…else 语句</h2><p>Lua if 语句可以与 else 语句搭配使用, 在 if 条件表达式为 false 时执行 else 语句代码块。</p>
<h3 id="语法格式"><a href="#语法格式" class="headerlink" title="语法格式"></a>语法格式</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(布尔表达式)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 布尔表达式为 true 时执行该语句块 --]</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="comment">--[ 布尔表达式为 false 时执行该语句块 --]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在布尔表达式为 true 时会if中的代码块会被执行，在布尔表达式为 false 时，else 的代码块会被执行。</p>
<p>Lua认为false和nil为假，true 和非nil为真。要注意的是Lua中 0 为 true。</p>
<h3 id="实例-7"><a href="#实例-7" class="headerlink" title="实例"></a>实例</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 定义变量 --]</span></span><br><span class="line">a = <span class="number">100</span>;</span><br><span class="line"><span class="comment">--[ 检查条件 --]</span></span><br><span class="line"><span class="keyword">if</span>( a &lt; <span class="number">20</span> )</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ if 条件为 true 时执行该语句块 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 小于 20&quot;</span> )</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="comment">--[ if 条件为 false 时执行该语句块 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 大于 20&quot;</span> )</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a 的值为 :&quot;</span>, a)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a 大于 <span class="number">20</span></span><br><span class="line">a 的值为 :    <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h2 id="if…elseif…else-语句"><a href="#if…elseif…else-语句" class="headerlink" title="if…elseif…else 语句"></a>if…elseif…else 语句</h2><p>Lua if 语句可以与 elseif…else 语句搭配使用, 在 if 条件表达式为 false 时执行 elseif…else 语句代码块，用于检测多个条件语句。</p>
<p>Lua if…elseif…else 语句语法格式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( 布尔表达式 <span class="number">1</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式 1 为 true 时执行该语句块 --]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span>( 布尔表达式 <span class="number">2</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式 2 为 true 时执行该语句块 --]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elseif</span>( 布尔表达式 <span class="number">3</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 在布尔表达式 3 为 true 时执行该语句块 --]</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">   <span class="comment">--[ 如果以上布尔表达式都不为 true 则执行该语句块 --]</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="实例-8"><a href="#实例-8" class="headerlink" title="实例"></a>实例</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 定义变量 --]</span></span><br><span class="line">a = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[ 检查布尔条件 --]</span></span><br><span class="line"><span class="keyword">if</span>( a == <span class="number">10</span> )</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 如果条件为 true 打印以下信息 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 的值为 10&quot;</span> )</span><br><span class="line"><span class="keyword">elseif</span>( a == <span class="number">20</span> )</span><br><span class="line"><span class="keyword">then</span>  </span><br><span class="line">   <span class="comment">--[ if else if 条件为 true 时打印以下信息 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 的值为 20&quot;</span> )</span><br><span class="line"><span class="keyword">elseif</span>( a == <span class="number">30</span> )</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ if else if condition 条件为 true 时打印以下信息 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;a 的值为 30&quot;</span> )</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="comment">--[ 以上条件语句没有一个为 true 时打印以下信息 --]</span></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;没有匹配 a 的值&quot;</span> )</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a 的真实值为: &quot;</span>, a )</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">没有匹配 a 的值</span><br><span class="line">a 的真实值为:     <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h2 id="if…else-语句-1"><a href="#if…else-语句-1" class="headerlink" title="if…else 语句"></a>if…else 语句</h2><p>Lua if 语句允许嵌套, 这就意味着你可以在一个 if 或 else if 语句中插入其他的 if 或 else if 语句。</p>
<h3 id="语法格式-1"><a href="#语法格式-1" class="headerlink" title="语法格式"></a>语法格式</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( 布尔表达式 <span class="number">1</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ 布尔表达式 1 为 true 时执行该语句块 --]</span></span><br><span class="line">   <span class="keyword">if</span>(布尔表达式 <span class="number">2</span>)</span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">      <span class="comment">--[ 布尔表达式 2 为 true 时执行该语句块 --]</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>你可以用同样的方式嵌套 <strong>else if…else</strong> 语句。</p>
<h3 id="实例-9"><a href="#实例-9" class="headerlink" title="实例"></a>实例</h3><p>以下实例用于判断变量 a 和 b 的值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[ 定义变量 --]</span></span><br><span class="line">a = <span class="number">100</span>;</span><br><span class="line">b = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--[ 检查条件 --]</span></span><br><span class="line"><span class="keyword">if</span>( a == <span class="number">100</span> )</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="comment">--[ if 条件为 true 时执行以下 if 条件判断 --]</span></span><br><span class="line">   <span class="keyword">if</span>( b == <span class="number">200</span> )</span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line">      <span class="comment">--[ if 条件为 true 时执行该语句块 --]</span></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;a 的值为 100 b 的值为 200&quot;</span> );</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a 的值为 :&quot;</span>, a );</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;b 的值为 :&quot;</span>, b );</span><br></pre></td></tr></table></figure>

<p>以上代码执行结果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a 的值为 <span class="number">100</span> b 的值为 <span class="number">200</span></span><br><span class="line">a 的值为 :    <span class="number">100</span></span><br><span class="line">b 的值为 :    <span class="number">200</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/11/Lua-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/11/Lua-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/" class="post-title-link" itemprop="url">Lua-基本语法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-11 09:46:59 / 修改时间：12:19:28" itemprop="dateCreated datePublished" datetime="2022-10-11T09:46:59+08:00">2022-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Lua/" itemprop="url" rel="index"><span itemprop="name">Lua</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Lua环境"><a href="#Lua环境" class="headerlink" title="Lua环境"></a>Lua环境</h1><ol>
<li><p>Github 下载地址：<a target="_blank" rel="noopener" href="https://github.com/rjpcomputing/luaforwindows/releases">Releases · rjpcomputing&#x2F;luaforwindows · GitHub</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://code.google.com/p/luaforwindows/downloads/list">Google Code下载地址 </a></p>
</li>
<li><p>你也可以使用 Lua 官方推荐的方法使用 LuaDist：<a target="_blank" rel="noopener" href="http://luadist.org/">http://luadist.org/</a></p>
</li>
</ol>
<h1 id="简单语法"><a href="#简单语法" class="headerlink" title="简单语法"></a>简单语法</h1><h2 id="交互式编程"><a href="#交互式编程" class="headerlink" title="交互式编程"></a>交互式编程</h2><p>Lua 提供了交互式编程模式。</p>
<p>我们可以在命令行中输入程序并立即查看效果。</p>
<p>Lua 交互式编程模式可以通过命令 lua -i 或 lua 来启用：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lua -i </span><br><span class="line">$ Lua <span class="number">5.3</span><span class="number">.0</span>  Copyright (C) <span class="number">1994</span><span class="number">-2015</span> Lua.org, PUC-Rio</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<p>在命令行中，输入以下命令:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;Hello World！&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>接着我们按下回车键，输出结果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;Hello World！&quot;</span>)</span><br><span class="line">Hello World！</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<h2 id="脚本式编程"><a href="#脚本式编程" class="headerlink" title="脚本式编程"></a>脚本式编程</h2><p>我们可以将 Lua 程序代码保存到一个以 lua 结尾的文件，并执行，该模式称为脚本式编程，如我们将如下代码存储在名为 hello.lua 的脚本文件中：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello World！&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;www.runoob.com&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>使用 lua 名执行以上脚本，输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lua hello.lua</span><br><span class="line">Hello World！</span><br><span class="line">www.runoob.com</span><br></pre></td></tr></table></figure>

<p>我们也可以将代码修改为如下形式来执行脚本（在开头添加：#!&#x2F;usr&#x2F;local&#x2F;bin&#x2F;lua）：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/<span class="keyword">local</span>/bin/lua</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello World！&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;www.runoob.com&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>以上代码中，我们指定了 Lua 的解释器 &#x2F;usr&#x2F;local&#x2F;bin directory。加上 # 号标记解释器会忽略它。接下来我们为脚本添加可执行权限，并执行：</p>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="单行注释"><a href="#单行注释" class="headerlink" title="单行注释"></a>单行注释</h3><p>两个减号是单行注释:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--</span></span><br></pre></td></tr></table></figure>

<h3 id="多行注释"><a href="#多行注释" class="headerlink" title="多行注释"></a>多行注释</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> 多行注释</span></span><br><span class="line"><span class="comment"> --]]</span></span><br></pre></td></tr></table></figure>

<h2 id="标示符"><a href="#标示符" class="headerlink" title="标示符"></a>标示符</h2><p>Lua 标示符用于定义一个变量，函数获取其他用户定义的项。</p>
<p>标示符以一个字母 A 到 Z 或 a 到 z 或下划线 _ 开头后加上 0 个或多个字母，下划线，数字（0 到 9）。</p>
<p><strong>最好不要使用下划线加大写字母的标示符</strong>，因为Lua的保留字也是这样的。</p>
<p>Lua 不允许使用特殊字符如 <strong>@</strong>, <strong>$</strong>, 和 <strong>%</strong> 来定义标示符。 Lua 是一个区分大小写的编程语言。因此在 Lua 中 Runoob 与 runoob 是两个不同的标示符。以下列出了一些正确的标示符：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mohd         zara      abc     move_name    a_123</span><br><span class="line">myname50     _temp     j       a23b9        retVal</span><br></pre></td></tr></table></figure>

<h2 id="关键词"><a href="#关键词" class="headerlink" title="关键词"></a>关键词</h2><p>以下列出了 Lua 的保留关键词。</p>
<p>保留关键字不能作为常量或变量或其他用户自定义标示符：</p>
<table>
<thead>
<tr>
<th>and</th>
<th>break</th>
<th>do</th>
<th>else</th>
</tr>
</thead>
<tbody><tr>
<td>elseif</td>
<td>end</td>
<td>false</td>
<td>for</td>
</tr>
<tr>
<td>function</td>
<td>if</td>
<td>in</td>
<td>local</td>
</tr>
<tr>
<td>nil</td>
<td>not</td>
<td>or</td>
<td>repeat</td>
</tr>
<tr>
<td>return</td>
<td>then</td>
<td>true</td>
<td>until</td>
</tr>
<tr>
<td>while</td>
<td>goto</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>一般约定，以下划线开头连接一串大写字母的名字（比如 _VERSION）被保留用于 Lua 内部全局变量。</p>
<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><p>在默认情况下，变量总是认为是全局的。</p>
<p>全局变量不需要声明，给一个变量赋值后即创建了这个全局变量，访问一个没有初始化的全局变量也不会出错，只不过得到的结果是：nil。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(b)</span><br><span class="line"><span class="literal">nil</span></span><br><span class="line">&gt; b=<span class="number">10</span></span><br><span class="line">&gt; <span class="built_in">print</span>(b)</span><br><span class="line"><span class="number">10</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>如果你想删除一个全局变量，只需要将变量赋值为nil。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b = <span class="literal">nil</span></span><br><span class="line"><span class="built_in">print</span>(b)      <span class="comment">--&gt; nil</span></span><br></pre></td></tr></table></figure>

<p>这样变量b就好像从没被使用过一样。换句话说, 当且仅当一个变量不等于nil时，这个变量即存在。</p>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><p>Lua 是动态类型语言，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回。</p>
<p>Lua 中有 8 个基本类型分别为：nil、boolean、number、string、userdata、function、thread 和 table。</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>nil</td>
<td>这个最简单，只有值nil属于该类，表示一个无效值（在条件表达式中相当于false）。</td>
</tr>
<tr>
<td>boolean</td>
<td>包含两个值：false和true。</td>
</tr>
<tr>
<td>number</td>
<td>表示双精度类型的实浮点数</td>
</tr>
<tr>
<td>string</td>
<td>字符串由一对双引号或单引号来表示</td>
</tr>
<tr>
<td>function</td>
<td>由 C 或 Lua 编写的函数</td>
</tr>
<tr>
<td>userdata</td>
<td>表示任意存储在变量中的C数据结构</td>
</tr>
<tr>
<td>thread</td>
<td>表示执行的独立线路，用于执行协同程序</td>
</tr>
<tr>
<td>table</td>
<td>Lua 中的表（table）其实是一个”关联数组”（associative arrays），数组的索引可以是数字、字符串或表类型。在 Lua 里，table 的创建是通过”构造表达式”来完成，最简单构造表达式是{}，用来创建一个空表。</td>
</tr>
</tbody></table>
<p>我们可以使用 type 函数测试给定变量或者值的类型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;Hello world&quot;</span>))      <span class="comment">--&gt; string</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">10.4</span>*<span class="number">3</span>))             <span class="comment">--&gt; number</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">print</span>))              <span class="comment">--&gt; function</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">type</span>))               <span class="comment">--&gt; function</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">true</span>))               <span class="comment">--&gt; boolean</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">nil</span>))                <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">type</span>(X)))            <span class="comment">--&gt; string</span></span><br></pre></td></tr></table></figure>

<h2 id="nil（空）"><a href="#nil（空）" class="headerlink" title="nil（空）"></a>nil（空）</h2><p>nil 类型表示一种没有任何有效值，它只有一个值 – nil，例如打印一个没有赋值的变量，便会输出一个 nil 值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(<span class="built_in">type</span>(a))</span><br><span class="line"><span class="literal">nil</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>对于全局变量和 table，nil 还有一个”删除”作用，给全局变量或者 table 表里的变量赋一个 nil 值，等同于把它们删掉，执行下面代码就知：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tab1 = &#123; key1 = <span class="string">&quot;val1&quot;</span>, key2 = <span class="string">&quot;val2&quot;</span>, <span class="string">&quot;val3&quot;</span> &#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(tab1) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k .. <span class="string">&quot; - &quot;</span> .. v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">tab1.key1 = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(tab1) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k .. <span class="string">&quot; - &quot;</span> .. v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="nil-作比较时应该加上双引号-“："><a href="#nil-作比较时应该加上双引号-“：" class="headerlink" title="nil 作比较时应该加上双引号 “："></a>nil 作比较时应该加上双引号 “：</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">type</span>(X)</span><br><span class="line"><span class="literal">nil</span></span><br><span class="line">&gt; <span class="built_in">type</span>(X)==<span class="literal">nil</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">&gt; <span class="built_in">type</span>(X)==<span class="string">&quot;nil&quot;</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>type(X)&#x3D;&#x3D;nil 结果为 <strong>false</strong> 的原因是 type(X) 实质是返回的 “nil” 字符串，是一个 string 类型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>(<span class="built_in">type</span>(X))==<span class="built_in">string</span></span><br></pre></td></tr></table></figure>

<h2 id="boolean（布尔）"><a href="#boolean（布尔）" class="headerlink" title="boolean（布尔）"></a>boolean（布尔）</h2><p>boolean 类型只有两个可选值：true（真） 和 false（假），Lua 把 false 和 nil 看作是 false，其他的都为 true，数字 0 也是 true:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">true</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">false</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">nil</span>))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> <span class="literal">false</span> <span class="keyword">or</span> <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;至少有一个是 true&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;false 和 nil 都为 false&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;数字 0 是 true&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;数字 0 为 false&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>以上代码执行结果如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ lua test.lua </span><br><span class="line">boolean</span><br><span class="line">boolean</span><br><span class="line"><span class="literal">nil</span></span><br><span class="line"><span class="literal">false</span> 和 <span class="literal">nil</span> 都为 <span class="literal">false</span></span><br><span class="line">数字 <span class="number">0</span> 是 <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="number（数字）"><a href="#number（数字）" class="headerlink" title="number（数字）"></a>number（数字）</h2><p>Lua 默认只有一种 number 类型 – double（双精度）类型（默认类型可以修改 luaconf.h 里的定义），以下几种写法都被看作是 number 类型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">2.2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">0.2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">2e+1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">0.2e-1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">7.8263692594256e-06</span>))</span><br></pre></td></tr></table></figure>

<p>以上代码执行结果：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">number</span><br><span class="line">number</span><br><span class="line">number</span><br><span class="line">number</span><br><span class="line">number</span><br><span class="line">number</span><br></pre></td></tr></table></figure>

<h2 id="string（字符串）"><a href="#string（字符串）" class="headerlink" title="string（字符串）"></a>string（字符串）</h2><p>字符串由一对双引号或单引号来表示。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string1 = <span class="string">&quot;this is string1&quot;</span></span><br><span class="line">string2 = <span class="string">&#x27;this is string2&#x27;</span></span><br></pre></td></tr></table></figure>

<p>也可以用 2 个方括号 “[[]]” 来表示”一块”字符串。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="string">[[</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;a href=&quot;http://www.runoob.com/&quot;&gt;菜鸟教程&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="built_in">print</span>(html)</span><br></pre></td></tr></table></figure>

<p>以下代码执行结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;http://www.runoob.com/&quot;</span>&gt;菜鸟教程&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>在对一个数字字符串上进行算术操作时，Lua 会尝试将这个数字字符串转成一个数字:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;2&quot;</span> + <span class="number">6</span>)</span><br><span class="line"><span class="number">8.0</span></span><br><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;2&quot;</span> + <span class="string">&quot;6&quot;</span>)</span><br><span class="line"><span class="number">8.0</span></span><br><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;2 + 6&quot;</span>)</span><br><span class="line"><span class="number">2</span> + <span class="number">6</span></span><br><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;-2e2&quot;</span> * <span class="string">&quot;6&quot;</span>)</span><br><span class="line"><span class="number">-1200.0</span></span><br><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span> + <span class="number">1</span>)</span><br><span class="line"><span class="built_in">stdin</span>:<span class="number">1</span>: attempt to perform arithmetic on a <span class="built_in">string</span> value</span><br><span class="line">stack <span class="built_in">traceback</span>:</span><br><span class="line">        <span class="built_in">stdin</span>:<span class="number">1</span>: <span class="keyword">in</span> main chunk</span><br><span class="line">        [C]: <span class="keyword">in</span> ?</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>以上代码中”error” + 1执行报错了，字符串连接使用的是 .. ，如：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span>(<span class="string">&quot;a&quot;</span> .. <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">ab</span><br><span class="line">&gt; <span class="built_in">print</span>(<span class="number">157</span> .. <span class="number">428</span>)</span><br><span class="line"><span class="number">157428</span></span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<p>使用 # 来计算字符串的长度，放在字符串前面，如下实例：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">len</span> = <span class="string">&quot;www.runoob.com&quot;</span></span><br><span class="line">&gt; <span class="built_in">print</span>(#<span class="built_in">len</span>)</span><br><span class="line"><span class="number">14</span></span><br><span class="line">&gt; <span class="built_in">print</span>(#<span class="string">&quot;www.runoob.com&quot;</span>)</span><br><span class="line"><span class="number">14</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<h2 id="table（表）"><a href="#table（表）" class="headerlink" title="table（表）"></a>table（表）</h2><p>在 Lua 里，table 的创建是通过”构造表达式”来完成，最简单构造表达式是{}，用来创建一个空表。也可以在表里添加一些数据，直接初始化表:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建一个空的 table</span></span><br><span class="line"><span class="keyword">local</span> tbl1 = &#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 直接初始表</span></span><br><span class="line"><span class="keyword">local</span> tbl2 = &#123;<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;pear&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;grape&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Lua 中的表（table）其实是一个”关联数组”（associative arrays），数组的索引可以是数字或者是字符串。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- table_test.lua 脚本文件</span></span><br><span class="line">a = &#123;&#125;</span><br><span class="line">a[<span class="string">&quot;key&quot;</span>] = <span class="string">&quot;value&quot;</span></span><br><span class="line">key = <span class="number">10</span></span><br><span class="line">a[key] = <span class="number">22</span></span><br><span class="line">a[key] = a[key] + <span class="number">11</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k .. <span class="string">&quot; : &quot;</span> .. v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>脚本执行结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lua table_test.lua </span><br><span class="line">key : value</span><br><span class="line"><span class="number">10</span> : <span class="number">33</span></span><br></pre></td></tr></table></figure>

<p>不同于其他语言的数组把 0 作为数组的初始索引，在 Lua 里表的默认初始索引一般以 1 开始。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- table_test2.lua 脚本文件</span></span><br><span class="line"><span class="keyword">local</span> tbl = &#123;<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;pear&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;grape&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> key, val <span class="keyword">in</span> <span class="built_in">pairs</span>(tbl) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Key&quot;</span>, key)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ lua table_test2.lua </span><br><span class="line">Key    <span class="number">1</span></span><br><span class="line">Key    <span class="number">2</span></span><br><span class="line">Key    <span class="number">3</span></span><br><span class="line">Key    <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>table 不会固定长度大小，有新数据添加时 table 长度会自动增长，没初始的 table 都是 nil。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- table_test3.lua 脚本文件</span></span><br><span class="line">a3 = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">    a3[i] = i</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">a3[<span class="string">&quot;key&quot;</span>] = <span class="string">&quot;val&quot;</span></span><br><span class="line"><span class="built_in">print</span>(a3[<span class="string">&quot;key&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(a3[<span class="string">&quot;none&quot;</span>])</span><br></pre></td></tr></table></figure>

<p>脚本执行结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lua table_test3.lua </span><br><span class="line">val</span><br><span class="line"><span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<h2 id="function（函数）"><a href="#function（函数）" class="headerlink" title="function（函数）"></a>function（函数）</h2><p>在 Lua 中，函数是被看作是”第一类值（First-Class Value）”，函数可以存在变量里:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- function_test.lua 脚本文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial1</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n * factorial1(n - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(factorial1(<span class="number">5</span>))</span><br><span class="line">factorial2 = factorial1</span><br><span class="line"><span class="built_in">print</span>(factorial2(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p>脚本执行结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lua function_test.lua </span><br><span class="line"><span class="number">120</span></span><br><span class="line"><span class="number">120</span></span><br></pre></td></tr></table></figure>

<p>function 可以以匿名函数（anonymous function）的方式通过参数传递:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- function_test2.lua 脚本文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testFun</span><span class="params">(tab,fun)</span></span></span><br><span class="line">        <span class="keyword">for</span> k ,v <span class="keyword">in</span> <span class="built_in">pairs</span>(tab) <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">print</span>(fun(k,v));</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tab=&#123;key1=<span class="string">&quot;val1&quot;</span>,key2=<span class="string">&quot;val2&quot;</span>&#125;;</span><br><span class="line">testFun(tab,</span><br><span class="line"><span class="function"><span class="keyword">function</span><span class="params">(key,val)</span></span><span class="comment">--匿名函数</span></span><br><span class="line">        <span class="keyword">return</span> key..<span class="string">&quot;=&quot;</span>..val;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>脚本执行结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lua function_test2.lua </span><br><span class="line">key1 = val1</span><br><span class="line">key2 = val2</span><br></pre></td></tr></table></figure>

<h2 id="thread（线程）"><a href="#thread（线程）" class="headerlink" title="thread（线程）"></a>thread（线程）</h2><p>在 Lua 里，最主要的线程是<strong>协同程序</strong>（coroutine）。它跟线程（thread）差不多，拥有自己独立的栈、局部变量和指令指针，可以跟其他协同程序共享全局变量和其他大部分东西。</p>
<p>线程跟协程的区别：线程可以同时多个运行，而<strong>协程任意时刻只能运行一个</strong>，并且<strong>处于运行状态的协程只有被挂起（suspend）时才会暂停。</strong></p>
<h2 id="userdata（自定义类型）"><a href="#userdata（自定义类型）" class="headerlink" title="userdata（自定义类型）"></a>userdata（自定义类型）</h2><p><strong>userdata</strong> 是一种用户自定义数据，用于表示一种由应用程序或 C&#x2F;C++ 语言库所创建的类型，可以将任意 C&#x2F;C++ 的任意数据类型的数据（通常是 struct 和 指针）存储到 Lua 变量中调用。</p>
<h1 id="Lua-变量"><a href="#Lua-变量" class="headerlink" title="Lua 变量"></a>Lua 变量</h1><p>变量在使用前，需要在代码中进行声明，即创建该变量。</p>
<p>编译程序执行代码之前编译器需要知道如何给语句变量开辟存储区，用于存储变量的值。</p>
<p>Lua 变量有三种类型：全局变量、局部变量、表中的域。</p>
<p>Lua 中的变量全是全局变量，哪怕是语句块或是函数里，除非用 <strong>local</strong> 显式声明为局部变量。</p>
<p>局部变量的作用域为从声明位置开始到所在语句块结束。</p>
<p>变量的默认值均为 nil。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- test.lua 文件脚本</span></span><br><span class="line">a = <span class="number">5</span>               <span class="comment">-- 全局变量</span></span><br><span class="line"><span class="keyword">local</span> b = <span class="number">5</span>         <span class="comment">-- 局部变量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">joke</span><span class="params">()</span></span></span><br><span class="line">    c = <span class="number">5</span>           <span class="comment">-- 全局变量</span></span><br><span class="line">    <span class="keyword">local</span> d = <span class="number">6</span>     <span class="comment">-- 局部变量</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">joke()</span><br><span class="line"><span class="built_in">print</span>(c,d)          <span class="comment">--&gt; 5 nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">6</span>     <span class="comment">-- 局部变量</span></span><br><span class="line">    b = <span class="number">6</span>           <span class="comment">-- 对局部变量重新赋值</span></span><br><span class="line">    <span class="built_in">print</span>(a,b);     <span class="comment">--&gt; 6 6</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a,b)      <span class="comment">--&gt; 5 6</span></span><br></pre></td></tr></table></figure>

<p>执行以上实例输出结果为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lua test.lua </span><br><span class="line"><span class="number">5</span>    <span class="literal">nil</span></span><br><span class="line"><span class="number">6</span>    <span class="number">6</span></span><br><span class="line"><span class="number">5</span>    <span class="number">6</span></span><br></pre></td></tr></table></figure>

<h2 id="赋值语句"><a href="#赋值语句" class="headerlink" title="赋值语句"></a>赋值语句</h2><p>赋值是改变一个变量的值和改变表域的最基本的方法。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;hello&quot;</span> .. <span class="string">&quot;world&quot;</span></span><br><span class="line">t.n = t.n + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>Lua 可以对多个变量同时赋值，变量列表和值列表的各个元素用逗号分开，赋值语句右边的值会依次赋给左边的变量。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = <span class="number">10</span>, <span class="number">2</span>*x       &lt;<span class="comment">--&gt;       a=10; b=2*x</span></span><br></pre></td></tr></table></figure>

<p>遇到赋值语句Lua会先计算右边所有的值然后再执行赋值操作，所以我们可以这样进行交换变量的值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x, y = y, x                     <span class="comment">-- swap &#x27;x&#x27; for &#x27;y&#x27;</span></span><br><span class="line">a[i], a[j] = a[j], a[i]         <span class="comment">-- swap &#x27;a[i]&#x27; for &#x27;a[j]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>当变量个数和值的个数不一致时，Lua会一直以变量个数为基础采取以下策略：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a. 变量个数 &gt; 值的个数             按变量个数补足<span class="literal">nil</span></span><br><span class="line">b. 变量个数 &lt; 值的个数             多余的值会被忽略</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a, b, c = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c)             <span class="comment">--&gt; 0   1   nil</span></span><br><span class="line"> </span><br><span class="line">a, b = a+<span class="number">1</span>, b+<span class="number">1</span>, b+<span class="number">2</span>     <span class="comment">-- value of b+2 is ignored</span></span><br><span class="line"><span class="built_in">print</span>(a,b)               <span class="comment">--&gt; 1   2</span></span><br><span class="line"> </span><br><span class="line">a, b, c = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c)             <span class="comment">--&gt; 0   nil   nil</span></span><br></pre></td></tr></table></figure>

<p>上面最后一个例子是一个常见的错误情况，注意：如果要对多个变量赋值必须依次对每个变量赋值。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a, b, c = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c)             <span class="comment">--&gt; 0   0   0</span></span><br></pre></td></tr></table></figure>

<p>多值赋值经常用来交换变量，或将函数调用返回给变量：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = f()</span><br></pre></td></tr></table></figure>

<p>f()返回两个值，第一个赋给a，第二个赋给b。</p>
<p>应该尽可能的使用局部变量，有两个好处：</p>
<ul>
<li><ol>
<li>避免命名冲突。</li>
</ol>
</li>
<li><ol start="2">
<li>访问局部变量的速度比全局变量更快。</li>
</ol>
</li>
</ul>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>对 table 的索引使用方括号 []。Lua 也提供了 . 操作。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t[i]</span><br><span class="line">t.i                 <span class="comment">-- 当索引为字符串类型时的一种简化写法</span></span><br><span class="line">gettable_event(t,i) <span class="comment">-- 采用索引访问本质上是一个类似这样的函数调用</span></span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>在Lua 语言中，全局变量无须声明即可使用，使用未经初始化的全局变量不会导致错误。当使用未经初始化的全局变量时，得到的结果为 <strong>nil</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/09/UE4-C-%E6%B8%B8%E6%88%8F%E5%BE%AA%E7%8E%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/09/UE4-C-%E6%B8%B8%E6%88%8F%E5%BE%AA%E7%8E%AF/" class="post-title-link" itemprop="url">UE4-C++-游戏循环</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-09 18:11:35 / 修改时间：19:17:35" itemprop="dateCreated datePublished" datetime="2022-10-09T18:11:35+08:00">2022-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unreal-engine/" itemprop="url" rel="index"><span itemprop="name">unreal engine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>开个坑吧！这一块的东西慢慢更新！</p>
<p>这一块知识内容是在面试杭州余烬科技的时候，他们的面试官推荐给我的。</p>
<p>还提供了一个链接<a target="_blank" rel="noopener" href="https://gameprogrammingpatterns.com/game-loop.html">Game Loop &amp;middot; Sequencing Patterns &amp;middot; Game Programming Patterns</a>。刚刚简单看了一下，觉得受益匪浅。所以此篇用于在学习过程中做一个简单的小结！</p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>总所周知，游戏时间和现实时间是同时进行的。</p>
<p>而这个游戏循环的作用是：将<code>玩家输入</code>和<code>处理器处理</code>在游戏时间中分离开来</p>
<p>实际上<strong>游戏循环</strong>在游戏过程中不断运行。循环的每一轮，它都会<strong>不阻塞地处理用户输入</strong>，<strong>更新游戏状态</strong>，并 <strong>渲染游戏</strong>。它跟踪时间的流逝以<strong>控制游戏的速度</strong>。</p>
<h1 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h1><ol>
<li>游戏循环的第一个关键部分：它处理用户输入，但不等待。循环始终保持运行状态：</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">processInput</span>();<span class="comment">//处理自上次调用以来发生的任何用户输入。</span></span><br><span class="line">  <span class="built_in">update</span>();<span class="comment">//将游戏模拟推进一步。它运行 AI 和物理（通常按此顺序）。</span></span><br><span class="line">  <span class="built_in">render</span>();<span class="comment">//绘制游戏以便玩家可以看到发生了什么。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><p>我们在这里讨论的循环是游戏中一些最重要的代码。他们说一个程序将90%的时间花在 10% 的代码上。你的游戏循环将牢牢地保持在这 10% 中。小心这段代码，并注意它的效率。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/09/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E9%97%AA%E7%94%B5%E6%8C%81%E7%BB%AD%E4%BC%A4%E5%AE%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/09/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E9%97%AA%E7%94%B5%E6%8C%81%E7%BB%AD%E4%BC%A4%E5%AE%B3/" class="post-title-link" itemprop="url">UE4-项目-TowerDefence-闪电持续伤害</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-09 15:23:20 / 修改时间：16:11:52" itemprop="dateCreated datePublished" datetime="2022-10-09T15:23:20+08:00">2022-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unreal-engine/" itemprop="url" rel="index"><span itemprop="name">unreal engine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="闪电伤害"><a href="#闪电伤害" class="headerlink" title="闪电伤害"></a>闪电伤害</h1><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="FTimerHandle"><a href="#FTimerHandle" class="headerlink" title="FTimerHandle"></a>FTimerHandle</h3><p>类似于一个定时器，规定在合适的时间调用某函数</p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><h5 id="声明定时器"><a href="#声明定时器" class="headerlink" title="声明定时器"></a>声明定时器</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FTimerHandle ChainAttackHandle;</span><br></pre></td></tr></table></figure>

<h5 id="生成定时器"><a href="#生成定时器" class="headerlink" title="生成定时器"></a>生成定时器</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">SetTimer</span>(ChainAttackHandle, <span class="keyword">this</span>, &amp;ARuleOfTheBullet::ChainAttack, <span class="number">0.1f</span>);</span><br></pre></td></tr></table></figure>

<h5 id="清除定时器"><a href="#清除定时器" class="headerlink" title="清除定时器"></a>清除定时器</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">ClearTimer</span>(ChainAttackHandle);</span><br></pre></td></tr></table></figure>



<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li><p>闪电伤害的本质是一个特效链接我方和地方，想要做出其连续伤害效果，最好是使用FTimerHandle定时调用伤害函数</p>
</li>
<li><p>至于伤害函数，就和普通的子弹一样<code>ApplyDamage()</code>申请伤害即可</p>
</li>
<li><p>注意：在伤害函数里面需要对FTimerHandle进行处理——在函数开始时清除FTimerHandle，用一个计数值来规定这个FTimerHandle能调用多少次，只有这个计数值大于0的时候才可以继续调用FTimerHandle，否则就按照函数最前面的销毁FTimerHandle</p>
</li>
</ol>
<h2 id="大致步骤"><a href="#大致步骤" class="headerlink" title="大致步骤"></a>大致步骤</h2><ol>
<li><p>在<code>RuleOfTheBullet.h</code>中</p>
<ul>
<li><p>声明定时器<code>FTimerHandle ChainAttackHandle</code></p>
</li>
<li><p>声明一个<code>unit8</code>的变量<code>ChainAttackCount</code>记录闪电攻击了多少次</p>
</li>
<li><p>声明函数<code>ChainAttack()</code></p>
</li>
</ul>
</li>
<li><p>在<code>RuleOfTheBullet.cpp</code>中</p>
<ul>
<li><p>遍历子弹类型为<code>BULLET_CHAIN</code>时</p>
</li>
<li><p>先获取世界，然后调用函数<code>GetTimerManager()</code>，接着调用函数<code>SetTimer()</code>设置（定时器，this，调用函数名称，多少秒调用一次）</p>
</li>
<li><p>定义函数<code>ChainAttack()</code></p>
<ul>
<li><p>首先在函数内清除原本计时器<code>GetWorld()-&gt;GetTimerManager().ClearTimer(ChainAttackHandle);</code></p>
</li>
<li><p>获取施法者，通过获取施法者的AI控制器来获取被施法者，然后写伤害函数（ApplyDamage）即可</p>
</li>
<li><p>写完伤害函数之后需要将<code>ChainAttackCount--</code></p>
</li>
<li><p>判断<code>ChainAttackCount &gt; 0</code>，是则在此调用计时器<code>GetWorld()-&gt;GetTimerManager().SetTimer(ChainAttackHandle, this, &amp;ARuleOfTheBullet::ChainAttack, 0.3f);</code></p>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="RuleOfTheBullet-h"><a href="#RuleOfTheBullet-h" class="headerlink" title="RuleOfTheBullet.h"></a>RuleOfTheBullet.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/Actor.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\TowerDefenceType.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character\Core\RuleOfTheCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components\SplineComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RuleOfTheBullet.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TOWERDEFENCE_API</span> ARuleOfTheBullet : <span class="keyword">public</span> AActor</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//碰撞盒子</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(VisibleAnywhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrubute&quot;</span>, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">USphereComponent</span>* BoxDamage;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//作为根组件</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(VisibleAnywhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrubute&quot;</span>, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">USceneComponent</span>* RootBullet;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//具有移动属性的组件</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(VisibleAnywhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrubute&quot;</span>, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">UProjectileMovementComponent</span>* ProjectileMovement;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">	<span class="comment">//子弹类型</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category = <span class="string">&quot;Bullet&quot;</span>)</span><br><span class="line">		TEnumAsByte&lt;EBulletType&gt; BulletType;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//子弹的伤害特效(碰撞后产生的特效)</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category = <span class="string">&quot;Bullet&quot;</span>)</span><br><span class="line">		UParticleSystem* DamgageParticle;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//开火特效</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category = <span class="string">&quot;Bullet&quot;</span>)</span><br><span class="line">		UParticleSystem* OpenFireParticle;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//样条线偏移值</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, Category = <span class="string">&quot;Bullet track line sp&quot;</span>)</span><br><span class="line">		<span class="type">float</span> SplineOffset;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sets default values for this actor&#x27;s properties</span></span><br><span class="line">	<span class="built_in">ARuleOfTheBullet</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">BeginPlay</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//球形碰撞组件和pawn进行重叠之后触发的事件</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">BeginOverlap</span><span class="params">(UPrimitiveComponent* OverlappedComponent<span class="comment">/*重叠的组件*/</span>, AActor* OtherActor<span class="comment">/*目标Actor*/</span>, UPrimitiveComponent* OtherComp<span class="comment">/*目标组件*/</span>, int32 OtherBodyIndex, <span class="type">bool</span> bFromSweep<span class="comment">/*是否开始扫描*/</span>, <span class="type">const</span> FHitResult&amp; SweepResult<span class="comment">/*扫描之后的结果*/</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">RadialDamage</span><span class="params">(<span class="type">const</span> FVector&amp; Origin, ARuleOfTheCharacter* InstigatorCharacter)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">UFUNCTION</span>()</span><br><span class="line">			<span class="function"><span class="type">void</span> <span class="title">ChainAttack</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">		USplineComponent* Spline;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">		<span class="type">float</span> CurrentSplineTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计时器</span></span><br><span class="line">	FTimerHandle ChainAttackHandle;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//计数器，记录闪电攻击了多少次</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">		uint8 ChainAttackCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">	<span class="comment">// Called every frame</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Tick</span><span class="params">(<span class="type">float</span> DeltaTime)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="RuleOfTheBullet-cpp"><a href="#RuleOfTheBullet-cpp" class="headerlink" title="RuleOfTheBullet.cpp"></a>RuleOfTheBullet.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character/Bullet/RuleOfTheBullet.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Particles\ParticleSystemComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components\SceneComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/SphereComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/ProjectileMovementComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character\Core\RuleOfTheAIController.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Kismet\GameplayStatics.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EngineUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">ARuleOfTheBullet::<span class="built_in">ARuleOfTheBullet</span>()</span><br><span class="line">&#123;</span><br><span class="line">	ChainAttackCount = <span class="number">3</span>;</span><br><span class="line">	SplineOffset = <span class="number">0.0f</span>;</span><br><span class="line">	CurrentSplineTime = <span class="number">0.0f</span>;</span><br><span class="line">	Spline = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="comment">// Set this actor to call Tick() every frame.  You can turn this off to improve performance if you don&#x27;t need it.</span></span><br><span class="line">	PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	BoxDamage = <span class="built_in">CreateDefaultSubobject</span>&lt;USphereComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;BulletNoxDamage&quot;</span>));</span><br><span class="line">	RootBullet = <span class="built_in">CreateDefaultSubobject</span>&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;BulletRootBullet&quot;</span>));</span><br><span class="line">	ProjectileMovement = <span class="built_in">CreateDefaultSubobject</span>&lt;UProjectileMovementComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;BulletProjectileMovement&quot;</span>));</span><br><span class="line"> 	</span><br><span class="line">	RootComponent = RootBullet;</span><br><span class="line">	BoxDamage-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line"></span><br><span class="line">	ProjectileMovement-&gt;MaxSpeed = <span class="number">2000.f</span>;</span><br><span class="line">	ProjectileMovement-&gt;InitialSpeed = <span class="number">1600.f</span>;</span><br><span class="line">	ProjectileMovement-&gt;ProjectileGravityScale = <span class="number">0.f</span>;</span><br><span class="line">	ProjectileMovement-&gt;UpdatedComponent = BoxDamage;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置默认子弹类型</span></span><br><span class="line">	BulletType = EBulletType::BULLET_DIRECT_LINE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//子弹生命周期</span></span><br><span class="line">	InitialLifeSpan = <span class="number">4.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::BeginPlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">BeginPlay</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成子弹的结构体</span></span><br><span class="line">	<span class="comment">//获取施法者Character</span></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()<span class="comment">/*生成子弹的伤害施加者*/</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//获取施法者的Controller</span></span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheAIController* InstigatorController = <span class="built_in">Cast</span>&lt;ARuleOfTheAIController&gt;(InstigatorCharacter-&gt;<span class="built_in">GetController</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//获取施法者的目标</span></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//遍历枚举，根据子弹类型来生成粒子特效</span></span><br><span class="line">				<span class="keyword">switch</span> (BulletType)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//无障碍直线攻击，则在Actor位置生成OpenFireParticle特效</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_DIRECT_LINE:</span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//非跟踪类型，类似手枪子弹类型，同上</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_LINE:</span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//Spline实现的跟踪类型</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE_SP:</span><br><span class="line">				&#123;</span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					<span class="comment">//生成特效</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					<span class="comment">//在当前组件内（this）生成样条线</span></span><br><span class="line">					Spline = <span class="built_in">NewObject</span>&lt;USplineComponent&gt;(<span class="keyword">this</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;SplineInstance&quot;</span>));</span><br><span class="line">					<span class="comment">//在关卡内注册该组件</span></span><br><span class="line">					Spline-&gt;<span class="built_in">RegisterComponent</span>();</span><br><span class="line"></span><br><span class="line">					<span class="comment">//生成样条线的下标为0的节点（起点）</span></span><br><span class="line">					Spline-&gt;<span class="built_in">SetLocationAtSplinePoint</span>(<span class="number">0</span>, <span class="built_in">GetActorLocation</span>(), ESplineCoordinateSpace::Local);</span><br><span class="line">					<span class="comment">//获取施法者和敌人之间的距离</span></span><br><span class="line">					FVector DistanceVector = InstigatorCharacter-&gt;<span class="built_in">GetActorLocation</span>() - TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">					<span class="comment">//敌人和施法者之间连线的中点位置</span></span><br><span class="line">					FVector Position = (DistanceVector / <span class="number">2</span>) + TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">					<span class="comment">//使用SplineOffset更新Position的Y轴</span></span><br><span class="line">					Position.Y += SplineOffset;</span><br><span class="line">					<span class="comment">//设置中点位置的高度0.5=50%</span></span><br><span class="line">					Position.Z = (DistanceVector.<span class="built_in">Size</span>() / <span class="number">2.f</span>) * <span class="number">0.5f</span>;</span><br><span class="line">					<span class="comment">//生成样条线下标为1的点（中点）</span></span><br><span class="line">					Spline-&gt;<span class="built_in">SetLocationAtSplinePoint</span>(<span class="number">1</span>, Position, ESplineCoordinateSpace::Local);</span><br><span class="line">					<span class="comment">//在敌人位置生成终点</span></span><br><span class="line">					Spline-&gt;<span class="built_in">AddSplinePoint</span>(TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>(), ESplineCoordinateSpace::Local);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//跟踪类型</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE:</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//在Actor位置生成OpenFireParticle特效</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					ProjectileMovement-&gt;bIsHomingProjectile = <span class="literal">true</span>;<span class="comment">//开启跟踪</span></span><br><span class="line">					ProjectileMovement-&gt;bRotationFollowsVelocity = <span class="literal">true</span>;<span class="comment">//旋转方向跟随速度方向进行旋转，使得子弹的拖尾特效效果正常</span></span><br><span class="line">					ProjectileMovement-&gt;HomingAccelerationMagnitude = <span class="number">4000.f</span>;<span class="comment">//设置跟踪导航的加速度</span></span><br><span class="line">					ProjectileMovement-&gt;HomingTargetComponent = TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>();<span class="comment">//设置跟踪方向是目标身上的跟踪点</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//物理实现的丢手雷范围伤害</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_RANGE_LINE:</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//先暂时取消初速度，不然直接就直线射击出去了</span></span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					<span class="comment">//开启子弹重力</span></span><br><span class="line">					ProjectileMovement-&gt;ProjectileGravityScale = <span class="number">1.f</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//目标位置和子弹生成位置之间的距离</span></span><br><span class="line">					FVector TargetFormOwnerVector = TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>() - <span class="built_in">GetActorLocation</span>();</span><br><span class="line"></span><br><span class="line">					<span class="comment">//子弹在路上的时间=距离/子弹速度</span></span><br><span class="line">					<span class="type">float</span> InTime = (TargetFormOwnerVector.<span class="built_in">Size</span>() / ProjectileMovement-&gt;InitialSpeed);</span><br><span class="line">					<span class="comment">//获取抛射物Z轴的垂直距离=Z轴重力*时间</span></span><br><span class="line">					<span class="type">float</span> Y = ProjectileMovement-&gt;<span class="built_in">GetGravityZ</span>() * InTime;</span><br><span class="line">					<span class="comment">//获取抛射物的水平距离=水平初速度速度*时间</span></span><br><span class="line">					<span class="type">float</span> X = ProjectileMovement-&gt;InitialSpeed * InTime;</span><br><span class="line">					<span class="comment">//勾股定理获取XY的斜边</span></span><br><span class="line">					<span class="type">float</span> V = FMath::<span class="built_in">Sqrt</span>(X * X + Y * Y);</span><br><span class="line"></span><br><span class="line">					<span class="comment">//此公式可推导出来，求出V*时间与TargetFormOwnerVector的比值，再由Acos()转换为弧度CosRadian</span></span><br><span class="line">					<span class="comment">//PI为圆周率</span></span><br><span class="line">					<span class="type">float</span> CosRadian = FMath::<span class="built_in">Acos</span>(TargetFormOwnerVector.<span class="built_in">Size</span>() / V * (InTime * (PI * <span class="number">0.1f</span>)<span class="comment">/*用于修正子弹初始位置与目标位置之间连线不是水平于地面的*/</span>));</span><br><span class="line">					FRotator Rot = <span class="built_in">GetActorRotation</span>();</span><br><span class="line">					<span class="comment">//弧度转换为角度</span></span><br><span class="line">					Rot.Pitch = CosRadian * (<span class="number">180</span> / PI);</span><br><span class="line">					<span class="comment">//设置子弹初始抛射角度</span></span><br><span class="line">					<span class="built_in">SetActorRotation</span>(Rot);</span><br><span class="line">					<span class="comment">//重新设置速度，此时抛射角度已经设定好了，所以发射之后就是抛出状态</span></span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">SetVelocityInLocalSpace</span>(<span class="built_in">FVector</span>(<span class="number">1.0f</span>, <span class="number">0.f</span>, <span class="number">0.f</span>) * ProjectileMovement-&gt;InitialSpeed);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//范围伤害，类似自爆——以自身为圆心，一定半径之内产生爆炸伤害</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_RANGE:</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//停下子弹的移动</span></span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					<span class="comment">//设置碰撞为无</span></span><br><span class="line">					BoxDamage-&gt;<span class="built_in">SetCollisionEnabled</span>(ECollisionEnabled::NoCollision);</span><br><span class="line">					<span class="comment">//调用自定义函数RadialDamage(圆心位置，施法者)</span></span><br><span class="line">					<span class="built_in">RadialDamage</span>(<span class="built_in">GetActorLocation</span>(), <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()));</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//链条类型，持续伤害类型;</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_CHAIN:</span><br><span class="line">				&#123;	</span><br><span class="line">				</span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					BoxDamage-&gt;<span class="built_in">SetCollisionEnabled</span>(ECollisionEnabled::NoCollision);</span><br><span class="line">					<span class="comment">//UGameplayStatics::SpawnEmitterAttached(OpenFireParticle, InstigatorCharacter-&gt;GetHomingPoint());</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAttached</span>(DamgageParticle, TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>());</span><br><span class="line"></span><br><span class="line">					<span class="comment">//通过计时器调用函数ChainAttack(),每0.1秒激活一次函数ChainAttack()</span></span><br><span class="line">					<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">SetTimer</span>(ChainAttackHandle, <span class="keyword">this</span>, &amp;ARuleOfTheBullet::ChainAttack, <span class="number">0.1f</span>);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//OnComponentBeginOverlap：是BoxDamage组件中自带的成员变量</span></span><br><span class="line">	<span class="comment">//代理绑定AddUniqueDynamic</span></span><br><span class="line">	BoxDamage-&gt;OnComponentBeginOverlap.<span class="built_in">AddUniqueDynamic</span>(<span class="keyword">this</span>, &amp;ARuleOfTheBullet::BeginOverlap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//当子弹与目标重叠时触发的函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::BeginOverlap</span><span class="params">(UPrimitiveComponent* OverlappedComponent, AActor* OtherActor, UPrimitiveComponent* OtherComp, int32 OtherBodyIndex, <span class="type">bool</span> bFromSweep, <span class="type">const</span> FHitResult&amp; SweepResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//找到伤害施加者</span></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()<span class="comment">/*生成子弹的伤害施加者*/</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//获取目标的Character</span></span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheCharacter* OtherCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(OtherActor))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//判断是否为敌方——没有队友伤害</span></span><br><span class="line">			<span class="keyword">if</span> (InstigatorCharacter-&gt;<span class="built_in">IsTeam</span>() != OtherCharacter-&gt;<span class="built_in">IsTeam</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//判断目标是否活着</span></span><br><span class="line">				<span class="keyword">if</span> (OtherCharacter-&gt;<span class="built_in">IsActive</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//生成伤害特效</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), DamgageParticle, SweepResult.Location);</span><br><span class="line"></span><br><span class="line">					<span class="comment">//计算伤害</span></span><br><span class="line">					<span class="type">float</span> DamgageValue = Expression::<span class="built_in">GetDamage</span>(InstigatorCharacter, OtherCharacter);</span><br><span class="line">					<span class="keyword">switch</span> (BulletType)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//如果是BULLET_LINE类型和BULLET_TRACK_LINE类型，则碰撞之后就销毁Actor</span></span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_DIRECT_LINE:</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_LINE:</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE:</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//此函数接口会激活施法者的TakeDamage伤害接口</span></span><br><span class="line">							UGameplayStatics::<span class="built_in">ApplyDamage</span>(</span><br><span class="line">								OtherCharacter,<span class="comment">//被命中者</span></span><br><span class="line">								DamgageValue,<span class="comment">//伤害数值</span></span><br><span class="line">								InstigatorCharacter-&gt;<span class="built_in">GetController</span>(),<span class="comment">//施法者的控制器</span></span><br><span class="line">								InstigatorCharacter,<span class="comment">//施法者</span></span><br><span class="line">								UDamageType::<span class="built_in">StaticClass</span>()<span class="comment">/*默认伤害类型，后面会修改*/</span>);</span><br><span class="line">								<span class="built_in">Destroy</span>();</span><br><span class="line">								<span class="keyword">break</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_RANGE_LINE: </span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">RadialDamage</span>(OtherCharacter-&gt;<span class="built_in">GetActorLocation</span>(), InstigatorCharacter);</span><br><span class="line">							<span class="built_in">Destroy</span>();</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::RadialDamage</span><span class="params">(<span class="type">const</span> FVector&amp; Origin<span class="comment">/*圆心点*/</span>, ARuleOfTheCharacter* InstigatorCharacter<span class="comment">/*施法者*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InstigatorCharacter)<span class="comment">//判断施法者是否有效</span></span><br><span class="line">	&#123;</span><br><span class="line">		TArray&lt;AActor*&gt; IngoreActors;<span class="comment">//友方类数组，用于忽略伤害</span></span><br><span class="line">		TArray&lt;ARuleOfTheCharacter*&gt; TargetActors;<span class="comment">//目标类数组，施加伤害</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//迭代器遍历关卡中的所有ARuleOfTheCharacter类</span></span><br><span class="line">		<span class="keyword">for</span> (TActorIterator&lt;ARuleOfTheCharacter&gt;<span class="built_in">it</span>(<span class="built_in">GetWorld</span>(), ARuleOfTheCharacter::<span class="built_in">StaticClass</span>()); it; ++it)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//TheCharacter用于存储敌方</span></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TheCharacter = *it)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//计算施法者与敌方之间的距离</span></span><br><span class="line">				FVector VDistance = TheCharacter-&gt;<span class="built_in">GetActorLocation</span>() - InstigatorCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">//如果距离不超过1400即可进攻</span></span><br><span class="line">				<span class="keyword">if</span> (VDistance.<span class="built_in">Size</span>() &lt;= <span class="number">1400</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//判断敌方是否为敌方</span></span><br><span class="line">					<span class="keyword">if</span> (TheCharacter-&gt;<span class="built_in">IsTeam</span>() == InstigatorCharacter-&gt;<span class="built_in">IsTeam</span>())</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//不是敌方则添加进友方类数组</span></span><br><span class="line">						IngoreActors.<span class="built_in">Add</span>(TheCharacter);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//是敌方则添加进目标类数组</span></span><br><span class="line">						TargetActors.<span class="built_in">Add</span>(TheCharacter);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//半径衰减范围伤害</span></span><br><span class="line">		UGameplayStatics::<span class="built_in">ApplyRadialDamageWithFalloff</span></span><br><span class="line">		(</span><br><span class="line">			<span class="built_in">GetWorld</span>()<span class="comment">/*关卡*/</span>,</span><br><span class="line">			<span class="number">100.f</span><span class="comment">/*最大伤害*/</span>,</span><br><span class="line">			<span class="number">10.f</span><span class="comment">/*最小伤害*/</span>,</span><br><span class="line">			Origin<span class="comment">/*伤害圆心点*/</span>,</span><br><span class="line">			<span class="number">400.f</span><span class="comment">/*内圆半径*/</span>,</span><br><span class="line">			<span class="number">1000.f</span><span class="comment">/*外圆半径*/</span>,</span><br><span class="line">			<span class="number">1.f</span><span class="comment">/*伤害衰减系数*/</span>,</span><br><span class="line">			UDamageType::<span class="built_in">StaticClass</span>()<span class="comment">/*伤害类型*/</span>,</span><br><span class="line">			IngoreActors<span class="comment">/*友方Actor*/</span>,</span><br><span class="line">			<span class="built_in">GetInstigator</span>()<span class="comment">/*施法者*/</span>,</span><br><span class="line">			<span class="built_in">GetInstigator</span>()-&gt;<span class="built_in">GetController</span>(),</span><br><span class="line">			ECollisionChannel::ECC_MAX</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::ChainAttack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ChainAttackHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//清除原本计时器</span></span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">ClearTimer</span>(ChainAttackHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//主要伤害区</span></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheAIController* InstigatorController = <span class="built_in">Cast</span>&lt;ARuleOfTheAIController&gt;(InstigatorCharacter-&gt;<span class="built_in">GetController</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//在目标的跟踪点上生成一个特效（敌人被攻击时的特效）</span></span><br><span class="line">				UGameplayStatics::<span class="built_in">SpawnEmitterAttached</span>(DamgageParticle, TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>());</span><br><span class="line">				<span class="comment">//在自身的开火点上生成一个特效</span></span><br><span class="line">				UGameplayStatics::<span class="built_in">SpawnEmitterAttached</span>(OpenFireParticle, InstigatorCharacter-&gt;<span class="built_in">GetHomingPoint</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">					UGameplayStatics::<span class="built_in">ApplyDamage</span>(</span><br><span class="line">						TargetCharacter,</span><br><span class="line">						<span class="number">100.f</span>,</span><br><span class="line">						InstigatorCharacter-&gt;<span class="built_in">GetController</span>(),</span><br><span class="line">						InstigatorCharacter,</span><br><span class="line">						UDamageType::<span class="built_in">StaticClass</span>());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">//攻击一次之后计数-1，如果计数器大于0，则继续通过计数器调用函数ChainAttack()，也就是递归调用</span></span><br><span class="line">	ChainAttackCount--;</span><br><span class="line">	<span class="keyword">if</span> (ChainAttackCount &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">SetTimer</span>(ChainAttackHandle, <span class="keyword">this</span>, &amp;ARuleOfTheBullet::ChainAttack, <span class="number">0.3f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Called every frame</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::Tick</span><span class="params">(<span class="type">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">Tick</span>(DeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheAIController* InstigatorController = <span class="built_in">Cast</span>&lt;ARuleOfTheAIController&gt;(InstigatorCharacter-&gt;<span class="built_in">GetController</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				InstigatorController-&gt;<span class="built_in">FindTarget</span>();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">switch</span> (BulletType)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_CHAIN:</span><br><span class="line">					&#123;</span><br><span class="line">						TArray&lt;USceneComponent*&gt; SceneComponent;</span><br><span class="line">						RootComponent-&gt;<span class="built_in">GetChildrenComponents</span>(<span class="literal">true</span><span class="comment">/*true包括所有子类*/</span>, SceneComponent);<span class="comment">//遍历附加在根组件的所有组件，将其中的组件添加到SceneComponent中</span></span><br><span class="line">						<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Tmp : SceneComponent)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">if</span> (UParticleSystemComponent* ParticleSystem = <span class="built_in">Cast</span>&lt;UParticleSystemComponent&gt;(Tmp))<span class="comment">//判断SceneComponent中是否存在UParticleSystemComponent类型</span></span><br><span class="line">							&#123;</span><br><span class="line">								<span class="comment">//设置特效的出发点</span></span><br><span class="line">								ParticleSystem-&gt;<span class="built_in">SetBeamSourcePoint</span>(<span class="number">0</span><span class="comment">/*发射器的index*/</span>, InstigatorCharacter-&gt;<span class="built_in">GetFirePoint</span>()-&gt;<span class="built_in">GetComponentLocation</span>(), <span class="number">0</span><span class="comment">/*光束index*/</span>);</span><br><span class="line">								<span class="comment">//设置特效的终点</span></span><br><span class="line">								ParticleSystem-&gt;<span class="built_in">SetBeamTargetPoint</span>(<span class="number">0</span>, TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>()-&gt;<span class="built_in">GetComponentLocation</span>(), <span class="number">0</span>);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE_SP:</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (Spline)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//施法者与敌人之间的距离</span></span><br><span class="line">							FVector DistanceVector = TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>() - InstigatorCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">							CurrentSplineTime += DeltaTime;<span class="comment">//样条线生成的时间</span></span><br><span class="line"></span><br><span class="line">							<span class="comment">//动态调整攻击速度，敌人距离很远的时候攻击速度慢，距离近了攻击速度就快了</span></span><br><span class="line">							<span class="type">float</span> Distance = Spline-&gt;<span class="built_in">GetSplineLength</span>() * (CurrentSplineTime / (DistanceVector.<span class="built_in">Size</span>() / <span class="number">1000.f</span>));<span class="comment">//样条线生成时间/子弹发射到打到敌人身上消耗的时间</span></span><br><span class="line">							<span class="comment">//获取沿样条线距离的世界位置</span></span><br><span class="line">							FVector Loction = Spline-&gt;<span class="built_in">GetWorldLocationAtDistanceAlongSpline</span>(Distance);</span><br><span class="line">							<span class="comment">//获取沿样条线距离的旋转</span></span><br><span class="line">							FRotator Rotator = Spline-&gt;<span class="built_in">GetRotationAtDistanceAlongSpline</span>(Distance, ESplineCoordinateSpace::Local);</span><br><span class="line"></span><br><span class="line">							<span class="comment">//更新样条线的位置和旋转信息</span></span><br><span class="line">							<span class="built_in">SetActorLocationAndRotation</span>(Loction, Rotator);</span><br><span class="line"></span><br><span class="line">							<span class="comment">//当样条线和目标距离&lt;= 100.f时</span></span><br><span class="line">							<span class="keyword">if</span> ((Loction - TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>()).<span class="built_in">Size</span>() &lt;= <span class="number">100.f</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								<span class="comment">//获取碰撞信息</span></span><br><span class="line">								FHitResult SweepResult;</span><br><span class="line">								<span class="comment">//将样条线的位置信息更新给碰撞信息</span></span><br><span class="line">								SweepResult.Location = Loction;</span><br><span class="line">								<span class="comment">//调用函数BeginOverlap生成伤害特效以及生成伤害等</span></span><br><span class="line">								<span class="built_in">BeginOverlap</span>(<span class="literal">nullptr</span>, TargetCharacter, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">false</span>, SweepResult);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!TargetCharacter-&gt;<span class="built_in">IsActive</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">Destroy</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">Destroy</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/08/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E4%BC%A4%E5%AE%B3%E5%85%AC%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/08/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E4%BC%A4%E5%AE%B3%E5%85%AC%E5%BC%8F/" class="post-title-link" itemprop="url">UE4-项目-TowerDefence-伤害公式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-08 16:31:19 / 修改时间：17:40:12" itemprop="dateCreated datePublished" datetime="2022-10-08T16:31:19+08:00">2022-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unreal-engine/" itemprop="url" rel="index"><span itemprop="name">unreal engine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="定义伤害公式"><a href="#定义伤害公式" class="headerlink" title="定义伤害公式"></a>定义伤害公式</h1><ol>
<li><p>在<code>StoneDefenceUtils.h</code>中声明函数<code>GetDamage(IRuleCharacter* Enemy, IRuleCharacter* Onwer)</code></p>
</li>
<li><p>在<code>StoneDefenceUtils.cpp</code>中定义函数</p>
<ol>
<li><p>判断<code>Enemy</code>与<code>Onwer</code>是否存在</p>
</li>
<li><p>返回值为<code>Enemy-&gt;GetCharacterData().PhysicalAttack / ((Onwer-&gt;GetCharacterData().Armor / 100.f) + 1);</code></p>
</li>
</ol>
</li>
<li><p>在子弹类中<code>ApplyDamage</code>函数内调用函数<code>GetDamage()</code>用于计算伤害，获取一个<code>float</code>类型的变量<code>DamgageValue</code>，并且替换掉原本随便定义的一个数值</p>
</li>
<li><p>在角色基类中的<code>TakeDamage</code>函数中同样调用函数<code>GetDamage()</code>计算伤害</p>
</li>
</ol>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="StoneDefenceUtils-h"><a href="#StoneDefenceUtils-h" class="headerlink" title="StoneDefenceUtils.h"></a>StoneDefenceUtils.h</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARuleOfTheCharacter</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ARuleOfTheBullet</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IRuleCharacter</span>;</span><br><span class="line"><span class="keyword">namespace</span> StoneDefenceUtils</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function">ARuleOfTheCharacter* <span class="title">FindTargetRecently</span><span class="params">(<span class="type">const</span> TArray&lt;ARuleOfTheCharacter*&gt;&amp; InCharacters<span class="comment">/*目标数组*/</span>, <span class="type">const</span> FVector&amp; MyLoc<span class="comment">/*我方位置*/</span>)</span></span>;</span><br><span class="line">	<span class="function">ARuleOfTheBullet* <span class="title">SpawnBullet</span><span class="params">(UWorld* World<span class="comment">/*生成关卡*/</span>, APawn* NewPawn<span class="comment">/*生成子弹的pawn（谁生成子弹）*/</span>, UClass* InClass<span class="comment">/*生成子弹的类*/</span>, <span class="type">const</span> FVector&amp; Loc<span class="comment">/*位置*/</span>, <span class="type">const</span> FRotator&amp; Rot<span class="comment">/*旋转信息*/</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Expression</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="type">float</span> <span class="title">GetDamage</span><span class="params">(IRuleCharacter* Enemy, IRuleCharacter* Onwer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="StoneDefenceUtils-cpp"><a href="#StoneDefenceUtils-cpp" class="headerlink" title="StoneDefenceUtils.cpp"></a>StoneDefenceUtils.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character\Bullet\RuleOfTheBullet.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character\Core\RuleOfTheCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interface\Character\RuleCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Data\Core\CharacterData.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off) </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function">ARuleOfTheCharacter* <span class="title">StoneDefenceUtils::FindTargetRecently</span><span class="params">(<span class="type">const</span> TArray&lt;ARuleOfTheCharacter*&gt;&amp; InCharacters, <span class="type">const</span> FVector&amp; MyLoc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//判断目标数组是否有效</span></span><br><span class="line">	<span class="keyword">if</span> (InCharacters.<span class="built_in">Num</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//定义一个目标距离，以及目标下标</span></span><br><span class="line">		<span class="type">float</span> TargetDistance = <span class="number">99999999</span>;</span><br><span class="line">		int32 Index = INDEX_NONE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//遍历目标数组</span></span><br><span class="line">		<span class="keyword">for</span> (int32 i = <span class="number">0</span>; i &lt; InCharacters.<span class="built_in">Num</span>(); i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//把遍历目标数组中的元素赋值给ARuleOfTheCharacter*类型的变量TargetCharacter</span></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InCharacters[i])</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//存储目标位置</span></span><br><span class="line">				FVector TargetLocation = TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">				<span class="comment">//我方距离和目标距离相减</span></span><br><span class="line">				FVector TmpVector = TargetLocation - MyLoc;</span><br><span class="line">				<span class="comment">//将FVector类型转换为float类型，方便判断</span></span><br><span class="line">				<span class="type">float</span> Distance = TmpVector.<span class="built_in">Size</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">//如果当前目标距离小于上一个目标距离且目标是活的</span></span><br><span class="line">				<span class="keyword">if</span> (Distance &lt; TargetDistance &amp;&amp; TargetCharacter-&gt;<span class="built_in">IsActive</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//更新目标下标和目标距离</span></span><br><span class="line">					Index = i;</span><br><span class="line">					TargetDistance = Distance;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//当目标下标不是INDEX_NONE时</span></span><br><span class="line">		<span class="keyword">if</span> (Index != INDEX_NONE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//返回当前目标元素（距离最近的一个目标）</span></span><br><span class="line">			<span class="keyword">return</span> InCharacters[Index];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ARuleOfTheBullet* <span class="title">StoneDefenceUtils::SpawnBullet</span><span class="params">(UWorld* World, APawn* NewPawn, UClass* InClass, <span class="type">const</span> FVector&amp; Loc, <span class="type">const</span> FRotator&amp; Rot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//判断关卡，发射子弹的pawn，子弹类是否有效</span></span><br><span class="line">	<span class="keyword">if</span> (World &amp;&amp; NewPawn &amp;&amp; InClass)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//创建FTransform类型变量Transform，存储生成子弹的位置和旋转信息</span></span><br><span class="line">		FTransform Transform;</span><br><span class="line">		Transform.<span class="built_in">SetLocation</span>(Loc);</span><br><span class="line">		Transform.<span class="built_in">SetRotation</span>(Rot.<span class="built_in">Quaternion</span>());<span class="comment">//将旋转信息通过Quaternion()函数转换为四元数类型，才可以赋值给SetRotation()函数</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//FActorSpawnParameters:传递给SpawnActor函数的可选参数的结构，有如下成员变量</span></span><br><span class="line">		<span class="comment">//Name：要指定为正在生成的Actor的名称的名称。如果未指定值，则生成的参与者的名称将使用[Class]_[Number]形式自动生成。</span></span><br><span class="line">		<span class="comment">//Template：生成新参与者时用作模板的参与者。生成的Actor将使用模板Actor的属性值初始化。如果保留为空，则类默认对象（CDO）将用于初始化生成的参与者。</span></span><br><span class="line">		<span class="comment">//Owner：产生这个Actor的Actor。（可以保留为空）</span></span><br><span class="line">		<span class="comment">//OverrideLevel：生成演员的ULevel，即此对象所在的UObject。如果保留为空，则使用所有者的对象所在的UObject。如果所有者为空，则使用持久级别</span></span><br><span class="line">		<span class="comment">//Instigator:对所产生的Actor造成的伤害负责的APawn。（可以保留为空）/也就是子弹的枪</span></span><br><span class="line">		FActorSpawnParameters ActorSpawnParameters;</span><br><span class="line">		ActorSpawnParameters.Instigator = NewPawn;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheBullet* Bullet = World-&gt;<span class="built_in">SpawnActor</span>&lt;ARuleOfTheBullet&gt;(InClass, Transform, ActorSpawnParameters))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> Bullet;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">Expression::GetDamage</span><span class="params">(IRuleCharacter* Enemy, IRuleCharacter* Onwer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Enemy &amp;&amp; Onwer)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> Enemy-&gt;<span class="built_in">GetCharacterData</span>().PhysicalAttack / ((Onwer-&gt;<span class="built_in">GetCharacterData</span>().Armor / <span class="number">100.f</span>) + <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//return 10.f;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,on) </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2 id="RuleOfTheCharacter-cpp"><a href="#RuleOfTheCharacter-cpp" class="headerlink" title="RuleOfTheCharacter.cpp"></a>RuleOfTheCharacter.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character/Core/RuleOfTheCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components\ArrowComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/BoxComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/WidgetComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UI\Character\UI_Health.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off) </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// Sets default values</span></span><br><span class="line">ARuleOfTheCharacter::<span class="built_in">ARuleOfTheCharacter</span>()</span><br><span class="line">	:<span class="built_in">bAttack</span>(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"> 	<span class="comment">// Set this character to call Tick() every frame.  You can turn this off to improve performance if you don&#x27;t need it.</span></span><br><span class="line">	PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	HomingPoint = <span class="built_in">CreateDefaultSubobject</span>&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;HomingPoint&quot;</span>));</span><br><span class="line">	Widget = <span class="built_in">CreateDefaultSubobject</span>&lt;UWidgetComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;Widget&quot;</span>));</span><br><span class="line">	OpenFirePoint = <span class="built_in">CreateDefaultSubobject</span>&lt;UArrowComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;SpawnPoint&quot;</span>));</span><br><span class="line">	TraceShowCharacterInformattion = <span class="built_in">CreateDefaultSubobject</span>&lt;UBoxComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;TraceBox&quot;</span>));</span><br><span class="line"></span><br><span class="line">	HomingPoint-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line">	Widget-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line">	OpenFirePoint-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line">	TraceShowCharacterInformattion-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置预设scanning碰撞通道</span></span><br><span class="line">	TraceShowCharacterInformattion-&gt;<span class="built_in">SetCollisionProfileName</span>(<span class="string">&quot;Scanning&quot;</span>);</span><br><span class="line">	<span class="comment">//设置碰撞检测盒子大小</span></span><br><span class="line">	TraceShowCharacterInformattion-&gt;<span class="built_in">SetBoxExtent</span>(<span class="built_in">FVector</span>(<span class="number">38</span>, <span class="number">38</span>, <span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetUniqueID</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheCharacter::BeginPlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">BeginPlay</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//角色生成默认ontroller</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetController</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SpawnDefaultController</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//UpDateUI();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheCharacter::UpDateUI</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Widget)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (UUI_Health* HealthUI = <span class="built_in">Cast</span>&lt;UUI_Health&gt;(Widget-&gt;<span class="built_in">GetUserWidgetObject</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			HealthUI-&gt;<span class="built_in">SetTitle</span>(<span class="built_in">GetCharacterData</span>().Name.<span class="built_in">ToString</span>());</span><br><span class="line">			HealthUI-&gt;<span class="built_in">SetHealth</span>(<span class="built_in">GetHeath</span>() / <span class="built_in">GetMaxHeath</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called every frame</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheCharacter::Tick</span><span class="params">(<span class="type">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">Tick</span>(DeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UpDateUI</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EGameCharacterType::Type <span class="title">ARuleOfTheCharacter::GetType</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> EGameCharacterType::Type::MAX;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">ARuleOfTheCharacter::TakeDamage</span><span class="params">(<span class="type">float</span> Damage, FDamageEvent <span class="type">const</span>&amp; DamageEvent, AController* EventInstigator, AActor* DamageCauser)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">TakeDamage</span>(Damage, DamageEvent, EventInstigator, DamageCauser);</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> DamageValue = Expression::<span class="built_in">GetDamage</span>(<span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(DamageCauser), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetCharacterData</span>().Health-= DamageValue;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsActive</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetCharacterData</span>().Health = <span class="number">0.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> DamageValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ARuleOfTheCharacter::IsDeath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetHeath</span>() &lt;= <span class="number">0.f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">ARuleOfTheCharacter::GetHeath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetCharacterData</span>().Health;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">ARuleOfTheCharacter::GetMaxHeath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//通过GUID获取GameState中的CharacterData</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetCharacterData</span>().MaxHealth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ARuleOfTheCharacter::IsTeam</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FCharacterData&amp; <span class="title">ARuleOfTheCharacter::GetCharacterData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetGameState</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GetGameState</span>()-&gt;<span class="built_in">GetCharacterData</span>(<span class="built_in">GetUniqueID</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> CharacterDataNULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,on) </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="RuleOfTheBullet-cpp"><a href="#RuleOfTheBullet-cpp" class="headerlink" title="RuleOfTheBullet.cpp"></a>RuleOfTheBullet.cpp</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character/Bullet/RuleOfTheBullet.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Particles\ParticleSystemComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components\SceneComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/SphereComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/ProjectileMovementComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character\Core\RuleOfTheAIController.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Kismet\GameplayStatics.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EngineUtils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 问题1：设置为三重花样子弹的时候，子弹没有击中怪物时，会产生悬停在空中，三秒之后才销毁的情况</span></span><br><span class="line"><span class="comment">// 问题2：在BULLET_RANGE子弹类型中，取消了子弹的初速度，这时子弹模型就会悬停在发射点，我想要这个模型不显示出来，怎么做到呢？</span></span><br><span class="line"><span class="comment">// 问题3：Spline-&gt;RegisterComponent();注册这个样条线，那么为啥要注册这个样条线呢？注册这个样条线的作用是什么？如果不注册会发生什么？</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ARuleOfTheBullet::<span class="built_in">ARuleOfTheBullet</span>()</span><br><span class="line">&#123;</span><br><span class="line">	ChainAttackCount = <span class="number">3</span>;</span><br><span class="line">	SplineOffset = <span class="number">0.0f</span>;</span><br><span class="line">	CurrentSplineTime = <span class="number">0.0f</span>;</span><br><span class="line">	Spline = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="comment">// Set this actor to call Tick() every frame.  You can turn this off to improve performance if you don&#x27;t need it.</span></span><br><span class="line">	PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	BoxDamage = <span class="built_in">CreateDefaultSubobject</span>&lt;USphereComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;BulletNoxDamage&quot;</span>));</span><br><span class="line">	RootBullet = <span class="built_in">CreateDefaultSubobject</span>&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;BulletRootBullet&quot;</span>));</span><br><span class="line">	ProjectileMovement = <span class="built_in">CreateDefaultSubobject</span>&lt;UProjectileMovementComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;BulletProjectileMovement&quot;</span>));</span><br><span class="line"> 	</span><br><span class="line">	RootComponent = RootBullet;</span><br><span class="line">	BoxDamage-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line"></span><br><span class="line">	ProjectileMovement-&gt;MaxSpeed = <span class="number">2000.f</span>;</span><br><span class="line">	ProjectileMovement-&gt;InitialSpeed = <span class="number">1600.f</span>;</span><br><span class="line">	ProjectileMovement-&gt;ProjectileGravityScale = <span class="number">0.f</span>;</span><br><span class="line">	ProjectileMovement-&gt;UpdatedComponent = BoxDamage;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置默认子弹类型</span></span><br><span class="line">	BulletType = EBulletType::BULLET_DIRECT_LINE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//子弹生命周期</span></span><br><span class="line">	InitialLifeSpan = <span class="number">4.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::BeginPlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">BeginPlay</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成子弹的结构体</span></span><br><span class="line">	<span class="comment">//获取施法者Character</span></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()<span class="comment">/*生成子弹的伤害施加者*/</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//获取施法者的Controller</span></span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheAIController* InstigatorController = <span class="built_in">Cast</span>&lt;ARuleOfTheAIController&gt;(InstigatorCharacter-&gt;<span class="built_in">GetController</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//获取施法者的目标</span></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//遍历枚举，根据子弹类型来生成粒子特效</span></span><br><span class="line">				<span class="keyword">switch</span> (BulletType)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//无障碍直线攻击，则在Actor位置生成OpenFireParticle特效</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_DIRECT_LINE:</span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//非跟踪类型，类似手枪子弹类型，同上</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_LINE:</span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//Spline实现的跟踪类型</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE_SP:</span><br><span class="line">				&#123;</span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					<span class="comment">//生成特效</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					<span class="comment">//在当前组件内（this）生成样条线</span></span><br><span class="line">					Spline = <span class="built_in">NewObject</span>&lt;USplineComponent&gt;(<span class="keyword">this</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;SplineInstance&quot;</span>));</span><br><span class="line">					<span class="comment">//在关卡内注册该组件</span></span><br><span class="line">					Spline-&gt;<span class="built_in">RegisterComponent</span>();</span><br><span class="line"></span><br><span class="line">					<span class="comment">//生成样条线的下标为0的节点（起点）</span></span><br><span class="line">					Spline-&gt;<span class="built_in">SetLocationAtSplinePoint</span>(<span class="number">0</span>, <span class="built_in">GetActorLocation</span>(), ESplineCoordinateSpace::Local);</span><br><span class="line">					<span class="comment">//获取施法者和敌人之间的距离</span></span><br><span class="line">					FVector DistanceVector = InstigatorCharacter-&gt;<span class="built_in">GetActorLocation</span>() - TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">					<span class="comment">//敌人和施法者之间连线的中点位置</span></span><br><span class="line">					FVector Position = (DistanceVector / <span class="number">2</span>) + TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">					<span class="comment">//使用SplineOffset更新Position的Y轴</span></span><br><span class="line">					Position.Y += SplineOffset;</span><br><span class="line">					<span class="comment">//设置中点位置的高度0.5=50%</span></span><br><span class="line">					Position.Z = (DistanceVector.<span class="built_in">Size</span>() / <span class="number">2.f</span>) * <span class="number">0.5f</span>;</span><br><span class="line">					<span class="comment">//生成样条线下标为1的点（中点）</span></span><br><span class="line">					Spline-&gt;<span class="built_in">SetLocationAtSplinePoint</span>(<span class="number">1</span>, Position, ESplineCoordinateSpace::Local);</span><br><span class="line">					<span class="comment">//在敌人位置生成终点</span></span><br><span class="line">					Spline-&gt;<span class="built_in">AddSplinePoint</span>(TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>(), ESplineCoordinateSpace::Local);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//跟踪类型</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE:</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//在Actor位置生成OpenFireParticle特效</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), OpenFireParticle, <span class="built_in">GetActorLocation</span>());</span><br><span class="line">					ProjectileMovement-&gt;bIsHomingProjectile = <span class="literal">true</span>;<span class="comment">//开启跟踪</span></span><br><span class="line">					ProjectileMovement-&gt;bRotationFollowsVelocity = <span class="literal">true</span>;<span class="comment">//旋转方向跟随速度方向进行旋转，使得子弹的拖尾特效效果正常</span></span><br><span class="line">					ProjectileMovement-&gt;HomingAccelerationMagnitude = <span class="number">4000.f</span>;<span class="comment">//设置跟踪导航的加速度</span></span><br><span class="line">					ProjectileMovement-&gt;HomingTargetComponent = TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>();<span class="comment">//设置跟踪方向是目标身上的跟踪点</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//物理实现的丢手雷范围伤害</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_RANGE_LINE:</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//先暂时取消初速度，不然直接就直线射击出去了</span></span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					<span class="comment">//开启子弹重力</span></span><br><span class="line">					ProjectileMovement-&gt;ProjectileGravityScale = <span class="number">1.f</span>;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//目标位置和子弹生成位置之间的距离</span></span><br><span class="line">					FVector TargetFormOwnerVector = TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>() - <span class="built_in">GetActorLocation</span>();</span><br><span class="line"></span><br><span class="line">					<span class="comment">//子弹在路上的时间=距离/子弹速度</span></span><br><span class="line">					<span class="type">float</span> InTime = (TargetFormOwnerVector.<span class="built_in">Size</span>() / ProjectileMovement-&gt;InitialSpeed);</span><br><span class="line">					<span class="comment">//获取抛射物Z轴的垂直距离=Z轴重力*时间</span></span><br><span class="line">					<span class="type">float</span> Y = ProjectileMovement-&gt;<span class="built_in">GetGravityZ</span>() * InTime;</span><br><span class="line">					<span class="comment">//获取抛射物的水平距离=水平初速度速度*时间</span></span><br><span class="line">					<span class="type">float</span> X = ProjectileMovement-&gt;InitialSpeed * InTime;</span><br><span class="line">					<span class="comment">//勾股定理获取XY的斜边</span></span><br><span class="line">					<span class="type">float</span> V = FMath::<span class="built_in">Sqrt</span>(X * X + Y * Y);</span><br><span class="line"></span><br><span class="line">					<span class="comment">//此公式可推导出来，求出V*时间与TargetFormOwnerVector的比值，再由Acos()转换为弧度CosRadian</span></span><br><span class="line">					<span class="comment">//PI为圆周率</span></span><br><span class="line">					<span class="type">float</span> CosRadian = FMath::<span class="built_in">Acos</span>(TargetFormOwnerVector.<span class="built_in">Size</span>() / V * (InTime * (PI * <span class="number">0.1f</span>)<span class="comment">/*用于修正子弹初始位置与目标位置之间连线不是水平于地面的*/</span>));</span><br><span class="line">					FRotator Rot = <span class="built_in">GetActorRotation</span>();</span><br><span class="line">					<span class="comment">//弧度转换为角度</span></span><br><span class="line">					Rot.Pitch = CosRadian * (<span class="number">180</span> / PI);</span><br><span class="line">					<span class="comment">//设置子弹初始抛射角度</span></span><br><span class="line">					<span class="built_in">SetActorRotation</span>(Rot);</span><br><span class="line">					<span class="comment">//重新设置速度，此时抛射角度已经设定好了，所以发射之后就是抛出状态</span></span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">SetVelocityInLocalSpace</span>(<span class="built_in">FVector</span>(<span class="number">1.0f</span>, <span class="number">0.f</span>, <span class="number">0.f</span>) * ProjectileMovement-&gt;InitialSpeed);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">//范围伤害，类似自爆——以自身为圆心，一定半径之内产生爆炸伤害</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_RANGE:</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//停下子弹的移动</span></span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					<span class="comment">//设置碰撞为无</span></span><br><span class="line">					BoxDamage-&gt;<span class="built_in">SetCollisionEnabled</span>(ECollisionEnabled::NoCollision);</span><br><span class="line">					<span class="comment">//调用自定义函数RadialDamage(圆心位置，施法者)</span></span><br><span class="line">					<span class="built_in">RadialDamage</span>(<span class="built_in">GetActorLocation</span>(), <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()));</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//链条类型，持续伤害类型;</span></span><br><span class="line">				<span class="keyword">case</span> EBulletType::BULLET_CHAIN:</span><br><span class="line">				&#123;	</span><br><span class="line">				</span><br><span class="line">					ProjectileMovement-&gt;<span class="built_in">StopMovementImmediately</span>();</span><br><span class="line">					BoxDamage-&gt;<span class="built_in">SetCollisionEnabled</span>(ECollisionEnabled::NoCollision);</span><br><span class="line">					<span class="comment">//UGameplayStatics::SpawnEmitterAttached(OpenFireParticle, InstigatorCharacter-&gt;GetHomingPoint());</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAttached</span>(DamgageParticle, TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>());</span><br><span class="line"></span><br><span class="line">					<span class="comment">//通过计时器调用函数ChainAttack(),每0.1秒激活一次函数ChainAttack()</span></span><br><span class="line">					<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">SetTimer</span>(ChainAttackHandle, <span class="keyword">this</span>, &amp;ARuleOfTheBullet::ChainAttack, <span class="number">0.1f</span>);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">//OnComponentBeginOverlap：是BoxDamage组件中自带的成员变量</span></span><br><span class="line">	<span class="comment">//代理绑定AddUniqueDynamic</span></span><br><span class="line">	BoxDamage-&gt;OnComponentBeginOverlap.<span class="built_in">AddUniqueDynamic</span>(<span class="keyword">this</span>, &amp;ARuleOfTheBullet::BeginOverlap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//当子弹与目标重叠时触发的函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::BeginOverlap</span><span class="params">(UPrimitiveComponent* OverlappedComponent, AActor* OtherActor, UPrimitiveComponent* OtherComp, int32 OtherBodyIndex, <span class="type">bool</span> bFromSweep, <span class="type">const</span> FHitResult&amp; SweepResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//找到伤害施加者</span></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()<span class="comment">/*生成子弹的伤害施加者*/</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//获取目标的Character</span></span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheCharacter* OtherCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(OtherActor))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//判断是否为敌方——没有队友伤害</span></span><br><span class="line">			<span class="keyword">if</span> (InstigatorCharacter-&gt;<span class="built_in">IsTeam</span>() != OtherCharacter-&gt;<span class="built_in">IsTeam</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//判断目标是否活着</span></span><br><span class="line">				<span class="keyword">if</span> (OtherCharacter-&gt;<span class="built_in">IsActive</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//生成伤害特效</span></span><br><span class="line">					UGameplayStatics::<span class="built_in">SpawnEmitterAtLocation</span>(<span class="built_in">GetWorld</span>(), DamgageParticle, SweepResult.Location);</span><br><span class="line"></span><br><span class="line">					<span class="comment">//计算伤害</span></span><br><span class="line">					<span class="type">float</span> DamgageValue = Expression::<span class="built_in">GetDamage</span>(InstigatorCharacter, OtherCharacter);</span><br><span class="line">					<span class="keyword">switch</span> (BulletType)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//如果是BULLET_LINE类型和BULLET_TRACK_LINE类型，则碰撞之后就销毁Actor</span></span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_DIRECT_LINE:</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_LINE:</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE:</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//此函数接口会激活施法者的TakeDamage伤害接口</span></span><br><span class="line">							UGameplayStatics::<span class="built_in">ApplyDamage</span>(</span><br><span class="line">								OtherCharacter,<span class="comment">//被命中者</span></span><br><span class="line">								DamgageValue,<span class="comment">//伤害数值</span></span><br><span class="line">								InstigatorCharacter-&gt;<span class="built_in">GetController</span>(),<span class="comment">//施法者的控制器</span></span><br><span class="line">								InstigatorCharacter,<span class="comment">//施法者</span></span><br><span class="line">								UDamageType::<span class="built_in">StaticClass</span>()<span class="comment">/*默认伤害类型，后面会修改*/</span>);</span><br><span class="line">								<span class="built_in">Destroy</span>();</span><br><span class="line">								<span class="keyword">break</span>;</span><br><span class="line">						&#125;</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_RANGE_LINE: </span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">RadialDamage</span>(OtherCharacter-&gt;<span class="built_in">GetActorLocation</span>(), InstigatorCharacter);</span><br><span class="line">							<span class="built_in">Destroy</span>();</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::RadialDamage</span><span class="params">(<span class="type">const</span> FVector&amp; Origin<span class="comment">/*圆心点*/</span>, ARuleOfTheCharacter* InstigatorCharacter<span class="comment">/*施法者*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InstigatorCharacter)<span class="comment">//判断施法者是否有效</span></span><br><span class="line">	&#123;</span><br><span class="line">		TArray&lt;AActor*&gt; IngoreActors;<span class="comment">//友方类数组，用于忽略伤害</span></span><br><span class="line">		TArray&lt;ARuleOfTheCharacter*&gt; TargetActors;<span class="comment">//目标类数组，施加伤害</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//迭代器遍历关卡中的所有ARuleOfTheCharacter类</span></span><br><span class="line">		<span class="keyword">for</span> (TActorIterator&lt;ARuleOfTheCharacter&gt;<span class="built_in">it</span>(<span class="built_in">GetWorld</span>(), ARuleOfTheCharacter::<span class="built_in">StaticClass</span>()); it; ++it)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//TheCharacter用于存储敌方</span></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TheCharacter = *it)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//计算施法者与敌方之间的距离</span></span><br><span class="line">				FVector VDistance = TheCharacter-&gt;<span class="built_in">GetActorLocation</span>() - InstigatorCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">//如果距离不超过1400即可进攻</span></span><br><span class="line">				<span class="keyword">if</span> (VDistance.<span class="built_in">Size</span>() &lt;= <span class="number">1400</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//判断敌方是否为敌方</span></span><br><span class="line">					<span class="keyword">if</span> (TheCharacter-&gt;<span class="built_in">IsTeam</span>() == InstigatorCharacter-&gt;<span class="built_in">IsTeam</span>())</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//不是敌方则添加进友方类数组</span></span><br><span class="line">						IngoreActors.<span class="built_in">Add</span>(TheCharacter);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">//是敌方则添加进目标类数组</span></span><br><span class="line">						TargetActors.<span class="built_in">Add</span>(TheCharacter);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//半径衰减范围伤害</span></span><br><span class="line">		UGameplayStatics::<span class="built_in">ApplyRadialDamageWithFalloff</span></span><br><span class="line">		(</span><br><span class="line">			<span class="built_in">GetWorld</span>()<span class="comment">/*关卡*/</span>,</span><br><span class="line">			<span class="number">100.f</span><span class="comment">/*最大伤害*/</span>,</span><br><span class="line">			<span class="number">10.f</span><span class="comment">/*最小伤害*/</span>,</span><br><span class="line">			Origin<span class="comment">/*伤害圆心点*/</span>,</span><br><span class="line">			<span class="number">400.f</span><span class="comment">/*内圆半径*/</span>,</span><br><span class="line">			<span class="number">1000.f</span><span class="comment">/*外圆半径*/</span>,</span><br><span class="line">			<span class="number">1.f</span><span class="comment">/*伤害衰减系数*/</span>,</span><br><span class="line">			UDamageType::<span class="built_in">StaticClass</span>()<span class="comment">/*伤害类型*/</span>,</span><br><span class="line">			IngoreActors<span class="comment">/*友方Actor*/</span>,</span><br><span class="line">			<span class="built_in">GetInstigator</span>()<span class="comment">/*施法者*/</span>,</span><br><span class="line">			<span class="built_in">GetInstigator</span>()-&gt;<span class="built_in">GetController</span>(),</span><br><span class="line">			ECollisionChannel::ECC_MAX</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::ChainAttack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ChainAttackHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//清除原本计时器</span></span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">ClearTimer</span>(ChainAttackHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//主要伤害区</span></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheAIController* InstigatorController = <span class="built_in">Cast</span>&lt;ARuleOfTheAIController&gt;(InstigatorCharacter-&gt;<span class="built_in">GetController</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//在目标的跟踪点上生成一个特效（敌人被攻击时的特效）</span></span><br><span class="line">				UGameplayStatics::<span class="built_in">SpawnEmitterAttached</span>(DamgageParticle, TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>());</span><br><span class="line">				<span class="comment">//在自身的开火点上生成一个特效</span></span><br><span class="line">				UGameplayStatics::<span class="built_in">SpawnEmitterAttached</span>(OpenFireParticle, InstigatorCharacter-&gt;<span class="built_in">GetHomingPoint</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">					UGameplayStatics::<span class="built_in">ApplyDamage</span>(</span><br><span class="line">						TargetCharacter,</span><br><span class="line">						<span class="number">100.f</span>,</span><br><span class="line">						InstigatorCharacter-&gt;<span class="built_in">GetController</span>(),</span><br><span class="line">						InstigatorCharacter,</span><br><span class="line">						UDamageType::<span class="built_in">StaticClass</span>());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">//攻击一次之后计数-1，如果计数器大于0，则继续通过计数器调用函数ChainAttack()，也就是递归调用</span></span><br><span class="line">	ChainAttackCount--;</span><br><span class="line">	<span class="keyword">if</span> (ChainAttackCount &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimerManager</span>().<span class="built_in">SetTimer</span>(ChainAttackHandle, <span class="keyword">this</span>, &amp;ARuleOfTheBullet::ChainAttack, <span class="number">0.3f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Called every frame</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheBullet::Tick</span><span class="params">(<span class="type">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">Tick</span>(DeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ARuleOfTheCharacter* InstigatorCharacter = <span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(<span class="built_in">GetInstigator</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (ARuleOfTheAIController* InstigatorController = <span class="built_in">Cast</span>&lt;ARuleOfTheAIController&gt;(InstigatorCharacter-&gt;<span class="built_in">GetController</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				InstigatorController-&gt;<span class="built_in">FindTarget</span>();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (ARuleOfTheCharacter* TargetCharacter = InstigatorController-&gt;Target.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">switch</span> (BulletType)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_CHAIN:</span><br><span class="line">					&#123;</span><br><span class="line">						TArray&lt;USceneComponent*&gt; SceneComponent;</span><br><span class="line">						RootComponent-&gt;<span class="built_in">GetChildrenComponents</span>(<span class="literal">true</span><span class="comment">/*true包括所有子类*/</span>, SceneComponent);<span class="comment">//遍历附加在根组件的所有组件，将其中的组件添加到SceneComponent中</span></span><br><span class="line">						<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Tmp : SceneComponent)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">if</span> (UParticleSystemComponent* ParticleSystem = <span class="built_in">Cast</span>&lt;UParticleSystemComponent&gt;(Tmp))<span class="comment">//判断SceneComponent中是否存在UParticleSystemComponent类型</span></span><br><span class="line">							&#123;</span><br><span class="line">								<span class="comment">//设置特效的出发点</span></span><br><span class="line">								ParticleSystem-&gt;<span class="built_in">SetBeamSourcePoint</span>(<span class="number">0</span><span class="comment">/*发射器的index*/</span>, InstigatorCharacter-&gt;<span class="built_in">GetFirePoint</span>()-&gt;<span class="built_in">GetComponentLocation</span>(), <span class="number">0</span><span class="comment">/*光束index*/</span>);</span><br><span class="line">								<span class="comment">//设置特效的终点</span></span><br><span class="line">								ParticleSystem-&gt;<span class="built_in">SetBeamTargetPoint</span>(<span class="number">0</span>, TargetCharacter-&gt;<span class="built_in">GetHomingPoint</span>()-&gt;<span class="built_in">GetComponentLocation</span>(), <span class="number">0</span>);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">case</span> EBulletType::BULLET_TRACK_LINE_SP:</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (Spline)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">//施法者与敌人之间的距离</span></span><br><span class="line">							FVector DistanceVector = TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>() - InstigatorCharacter-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">							CurrentSplineTime += DeltaTime;<span class="comment">//样条线生成的时间</span></span><br><span class="line"></span><br><span class="line">							<span class="comment">//动态调整攻击速度，敌人距离很远的时候攻击速度慢，距离近了攻击速度就快了</span></span><br><span class="line">							<span class="type">float</span> Distance = Spline-&gt;<span class="built_in">GetSplineLength</span>() * (CurrentSplineTime / (DistanceVector.<span class="built_in">Size</span>() / <span class="number">1000.f</span>));<span class="comment">//样条线生成时间/子弹发射到打到敌人身上消耗的时间</span></span><br><span class="line">							<span class="comment">//获取沿样条线距离的世界位置</span></span><br><span class="line">							FVector Loction = Spline-&gt;<span class="built_in">GetWorldLocationAtDistanceAlongSpline</span>(Distance);</span><br><span class="line">							<span class="comment">//获取沿样条线距离的旋转</span></span><br><span class="line">							FRotator Rotator = Spline-&gt;<span class="built_in">GetRotationAtDistanceAlongSpline</span>(Distance, ESplineCoordinateSpace::Local);</span><br><span class="line"></span><br><span class="line">							<span class="comment">//更新样条线的位置和旋转信息</span></span><br><span class="line">							<span class="built_in">SetActorLocationAndRotation</span>(Loction, Rotator);</span><br><span class="line"></span><br><span class="line">							<span class="comment">//当样条线和目标距离&lt;= 100.f时</span></span><br><span class="line">							<span class="keyword">if</span> ((Loction - TargetCharacter-&gt;<span class="built_in">GetActorLocation</span>()).<span class="built_in">Size</span>() &lt;= <span class="number">100.f</span>)</span><br><span class="line">							&#123;</span><br><span class="line">								<span class="comment">//获取碰撞信息</span></span><br><span class="line">								FHitResult SweepResult;</span><br><span class="line">								<span class="comment">//将样条线的位置信息更新给碰撞信息</span></span><br><span class="line">								SweepResult.Location = Loction;</span><br><span class="line">								<span class="comment">//调用函数BeginOverlap生成伤害特效以及生成伤害等</span></span><br><span class="line">								<span class="built_in">BeginOverlap</span>(<span class="literal">nullptr</span>, TargetCharacter, <span class="literal">nullptr</span>, <span class="number">0</span>, <span class="literal">false</span>, SweepResult);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!TargetCharacter-&gt;<span class="built_in">IsActive</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">Destroy</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">Destroy</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/08/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E6%9B%B4%E6%96%B0%E8%A1%80%E6%9D%A1%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/08/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E6%9B%B4%E6%96%B0%E8%A1%80%E6%9D%A1%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">UE4-项目-TowerDefence-更新血条方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-08 15:31:15 / 修改时间：16:17:40" itemprop="dateCreated datePublished" datetime="2022-10-08T15:31:15+08:00">2022-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unreal-engine/" itemprop="url" rel="index"><span itemprop="name">unreal engine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="创建血条"><a href="#创建血条" class="headerlink" title="创建血条"></a>创建血条</h1><h2 id="大致步骤"><a href="#大致步骤" class="headerlink" title="大致步骤"></a>大致步骤</h2><ol>
<li><p>创建一个继承自<code>RuleOfTheWidget</code>的C++类，取名为<code>UI_Health</code></p>
<ul>
<li><p>声明一个<code>UTextBlock*</code>类型的变量<code>Title</code></p>
</li>
<li><p>声明一个<code>UProgressBar*</code>类型的变量<code>Health</code></p>
</li>
<li><p>声明两个函数<code>SetTitle(const FString&amp; Msg)</code>以及<code>SetHealth(float HealthValue)</code></p>
</li>
<li><p>再cpp文件中定义两个函数</p>
<ul>
<li><p><code>Title-&gt;SetText(FText::FromString(Msg));</code></p>
</li>
<li><p><code>Health-&gt;SetPercent(HealthValue);</code></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>基于<code>UI_Health</code>创建一个蓝图类<code>Health_BP</code></p>
<ul>
<li><p>在蓝图中添加<code>UTextBlock*</code>以及<code>UProgressBar*</code>组件</p>
</li>
<li><p>注意名字需要和C++文件中的名字相同</p>
</li>
</ul>
</li>
<li><p>在角色基类中的<code>Widget</code>组件中的类设置为<code>Health_BP</code>，并且将显示方式设置为添加到屏幕</p>
<ul>
<li>注意：<code>Health_BP</code>蓝图中的大小以及位置需要合理，否则在角色基类中无法显示（如果位置不合理，就需要在角色基类中调整其<code>绘制大小</code>属性）</li>
</ul>
</li>
</ol>
<h2 id="部分代码"><a href="#部分代码" class="headerlink" title="部分代码"></a>部分代码</h2><h3 id="UI-Health-h"><a href="#UI-Health-h" class="headerlink" title="UI_Health.h"></a>UI_Health.h</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UI/Core/UI_RuleOfTheWidget.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UI_Health.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TOWERDEFENCE_API</span> UUI_Health : <span class="keyword">public</span> UUI_RuleOfTheWidget</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(meta = (BindWidget))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">UTextBlock</span>* Title;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(meta = (BindWidget))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">UProgressBar</span>* Health;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">NativeConstruct</span><span class="params">()</span><span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">SetTitle</span><span class="params">(<span class="type">const</span> FString&amp; Msg)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">SetHealth</span><span class="params">(<span class="type">float</span> HealthValue)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="UI-Health-cpp"><a href="#UI-Health-cpp" class="headerlink" title="UI_Health.cpp"></a>UI_Health.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UI/Character/UI_Health.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/TextBlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/ProgressBar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UUI_Health::NativeConstruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">NativeConstruct</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UUI_Health::SetTitle</span><span class="params">(<span class="type">const</span> FString&amp; Msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Title-&gt;<span class="built_in">SetText</span>(FText::<span class="built_in">FromString</span>(Msg));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UUI_Health::SetHealth</span><span class="params">(<span class="type">float</span> HealthValue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Health-&gt;<span class="built_in">SetPercent</span>(HealthValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="血条更新"><a href="#血条更新" class="headerlink" title="血条更新"></a>血条更新</h1><h2 id="大致步骤-1"><a href="#大致步骤-1" class="headerlink" title="大致步骤"></a>大致步骤</h2><ol>
<li><p>在角色基类<code>RuleOfTheCharacter</code>中声明函数<code>UpDateUI</code></p>
</li>
<li><p>在cpp中定义该函数，首先判断角色基类中的Wigeht是否为空</p>
</li>
<li><p>如果不为空则以<code>Widget-&gt;GetUserWidgetObject()</code>通过<code>Cast</code>类型转换为<code>UUI_Health*</code>类型的变量<code>HealthUI</code></p>
</li>
<li><p>再由<code>HealthUI</code>调用其内部函数<code>SetTitle()</code>以及<code>SetHealth()</code></p>
</li>
<li><p>参数分别为<code>GetCharacterData().Name.ToString()</code>，以及<code>GetHeath() / GetMaxHeath()</code></p>
</li>
<li><p>最后在帧更新调用函数<code>UpDateUI</code></p>
</li>
</ol>
<h2 id="部分代码-1"><a href="#部分代码-1" class="headerlink" title="部分代码"></a>部分代码</h2><h3 id="RuleOfTheCharacter-h"><a href="#RuleOfTheCharacter-h" class="headerlink" title="RuleOfTheCharacter.h"></a>RuleOfTheCharacter.h</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\TowerDefenceType.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/Character.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interface\Character\RuleCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Core/GameCore/TowerDefencePlayerController.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Core/GameCore/TowerDefenceGameState.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;RuleOfTheCharacter.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TOWERDEFENCE_API</span> ARuleOfTheCharacter : <span class="keyword">public</span> ACharacter,<span class="keyword">public</span> IRuleCharacter</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">		<span class="comment">//用于实现子弹跟踪效果的实现</span></span><br><span class="line">		<span class="built_in">UPROPERTY</span>(VisibleAnyWhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrbute&quot;</span>, meta = (AllowPrivateAccess=<span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">USceneComponent</span>* HomingPoint;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//用于显示等级，生命值等信息</span></span><br><span class="line">		<span class="built_in">UPROPERTY</span>(VisibleAnyWhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrbute&quot;</span>, meta = (AllowPrivateAccess=<span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">UWidgetComponent</span>* Widget;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">//角色及怪物子弹生成位置</span></span><br><span class="line">		<span class="built_in">UPROPERTY</span>(VisibleAnyWhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrbute&quot;</span>, meta = (AllowPrivateAccess=<span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">USceneComponent</span>* OpenFirePoint;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//用于捕捉鼠标射线</span></span><br><span class="line">		<span class="built_in">UPROPERTY</span>(VisibleAnyWhere, BlueprintReadOnly, Category = <span class="string">&quot;BaseAttrbute&quot;</span>, meta = (AllowPrivateAccess=<span class="string">&quot;true&quot;</span>))</span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">UBoxComponent</span>* TraceShowCharacterInformattion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// Sets default values for this character&#x27;s properties</span></span><br><span class="line">	<span class="built_in">ARuleOfTheCharacter</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">BeginPlay</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">UpDateUI</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//角色属性</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> EGameCharacterType::Type <span class="title">GetType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//继承自IRuleCharacter中的函数</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsDeath</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">float</span> <span class="title">GetHeath</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">float</span> <span class="title">GetMaxHeath</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsTeam</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FCharacterData&amp; <span class="title">GetCharacterData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:	</span><br><span class="line">	<span class="comment">// Called every frame</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Tick</span><span class="params">(<span class="type">float</span> DeltaTime)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">//Damage为伤害值</span></span><br><span class="line">	<span class="comment">//DamageEvent为伤害类型</span></span><br><span class="line">	<span class="comment">//EventInstigator为伤害当前Controller的Actor（被伤害目标）</span></span><br><span class="line">	<span class="comment">//DamageCauser为施加伤害的Actor</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">float</span> <span class="title">TakeDamage</span><span class="params">(<span class="type">float</span> Damage, <span class="keyword">struct</span> FDamageEvent <span class="type">const</span>&amp; DamageEvent, AController* EventInstigator, AActor* DamageCauser)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Blueprintable,BlueprintPure,Category=<span class="string">&quot;Tower|Attrubute&quot;</span>)</span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">IsActive</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> !<span class="built_in">IsDeath</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//将TowerDefencePlayerController连接进来</span></span><br><span class="line">	<span class="comment">//FORCEINLINE：强制内联函数</span></span><br><span class="line">	<span class="function">FORCEINLINE ATowerDefencePlayerController* <span class="title">GetGameController</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GetWorld</span>() ? <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstPlayerController</span>&lt;ATowerDefencePlayerController&gt;() : <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将TowerDefenceGameState连接进来</span></span><br><span class="line">	<span class="function">FORCEINLINE ATowerDefenceGameState* <span class="title">GetGameState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GetWorld</span>() ? <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetGameState</span>&lt;ATowerDefenceGameState&gt;() : <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//跟踪点</span></span><br><span class="line">	<span class="function">FORCEINLINE USceneComponent* <span class="title">GetHomingPoint</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> HomingPoint; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//开火点</span></span><br><span class="line">	<span class="function">FORCEINLINE USceneComponent* <span class="title">GetFirePoint</span><span class="params">()</span><span class="type">const</span> </span>&#123; <span class="keyword">return</span> OpenFirePoint; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//是否攻击</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(VisibleAnyWhere, BlueprintReadOnly, Category = <span class="string">&quot;AnimAttrubute&quot;</span>)</span><br><span class="line">		<span class="type">bool</span> bAttack;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="RuleOfTheCharacter-cpp"><a href="#RuleOfTheCharacter-cpp" class="headerlink" title="RuleOfTheCharacter.cpp"></a>RuleOfTheCharacter.cpp</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Character/Core/RuleOfTheCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components\ArrowComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/BoxComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/WidgetComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;UI\Character\UI_Health.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TowerDefence\StoneDefenceUtils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off) </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// Sets default values</span></span><br><span class="line">ARuleOfTheCharacter::<span class="built_in">ARuleOfTheCharacter</span>()</span><br><span class="line">	:<span class="built_in">bAttack</span>(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"> 	<span class="comment">// Set this character to call Tick() every frame.  You can turn this off to improve performance if you don&#x27;t need it.</span></span><br><span class="line">	PrimaryActorTick.bCanEverTick = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	HomingPoint = <span class="built_in">CreateDefaultSubobject</span>&lt;USceneComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;HomingPoint&quot;</span>));</span><br><span class="line">	Widget = <span class="built_in">CreateDefaultSubobject</span>&lt;UWidgetComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;Widget&quot;</span>));</span><br><span class="line">	OpenFirePoint = <span class="built_in">CreateDefaultSubobject</span>&lt;UArrowComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;SpawnPoint&quot;</span>));</span><br><span class="line">	TraceShowCharacterInformattion = <span class="built_in">CreateDefaultSubobject</span>&lt;UBoxComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;TraceBox&quot;</span>));</span><br><span class="line"></span><br><span class="line">	HomingPoint-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line">	Widget-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line">	OpenFirePoint-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line">	TraceShowCharacterInformattion-&gt;<span class="built_in">AttachToComponent</span>(RootComponent, FAttachmentTransformRules::KeepRelativeTransform);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置预设scanning碰撞通道</span></span><br><span class="line">	TraceShowCharacterInformattion-&gt;<span class="built_in">SetCollisionProfileName</span>(<span class="string">&quot;Scanning&quot;</span>);</span><br><span class="line">	<span class="comment">//设置碰撞检测盒子大小</span></span><br><span class="line">	TraceShowCharacterInformattion-&gt;<span class="built_in">SetBoxExtent</span>(<span class="built_in">FVector</span>(<span class="number">38</span>, <span class="number">38</span>, <span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetUniqueID</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called when the game starts or when spawned</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheCharacter::BeginPlay</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">BeginPlay</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//角色生成默认ontroller</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetController</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SpawnDefaultController</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//UpDateUI();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheCharacter::UpDateUI</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Widget)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (UUI_Health* HealthUI = <span class="built_in">Cast</span>&lt;UUI_Health&gt;(Widget-&gt;<span class="built_in">GetUserWidgetObject</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			HealthUI-&gt;<span class="built_in">SetTitle</span>(<span class="built_in">GetCharacterData</span>().Name.<span class="built_in">ToString</span>());</span><br><span class="line">			HealthUI-&gt;<span class="built_in">SetHealth</span>(<span class="built_in">GetHeath</span>() / <span class="built_in">GetMaxHeath</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Called every frame</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ARuleOfTheCharacter::Tick</span><span class="params">(<span class="type">float</span> DeltaTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">Tick</span>(DeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UpDateUI</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EGameCharacterType::Type <span class="title">ARuleOfTheCharacter::GetType</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> EGameCharacterType::Type::MAX;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">ARuleOfTheCharacter::TakeDamage</span><span class="params">(<span class="type">float</span> Damage, FDamageEvent <span class="type">const</span>&amp; DamageEvent, AController* EventInstigator, AActor* DamageCauser)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">TakeDamage</span>(Damage, DamageEvent, EventInstigator, DamageCauser);</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> DamageValue = Expression::<span class="built_in">GetDamage</span>(<span class="built_in">Cast</span>&lt;ARuleOfTheCharacter&gt;(DamageCauser), <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetCharacterData</span>().Health-= DamageValue;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsActive</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetCharacterData</span>().Health = <span class="number">0.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> DamageValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ARuleOfTheCharacter::IsDeath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetHeath</span>() &lt;= <span class="number">0.f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">ARuleOfTheCharacter::GetHeath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetCharacterData</span>().Health;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">ARuleOfTheCharacter::GetMaxHeath</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//通过GUID获取GameState中的CharacterData</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">GetCharacterData</span>().MaxHealth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ARuleOfTheCharacter::IsTeam</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FCharacterData&amp; <span class="title">ARuleOfTheCharacter::GetCharacterData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetGameState</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">GetGameState</span>()-&gt;<span class="built_in">GetCharacterData</span>(<span class="built_in">GetUniqueID</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> CharacterDataNULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,on) </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/08/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E8%A7%92%E8%89%B2%E7%94%9F%E6%88%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/08/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E8%A7%92%E8%89%B2%E7%94%9F%E6%88%90/" class="post-title-link" itemprop="url">UE4-项目-TowerDefence-角色生成</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-08 14:46:38 / 修改时间：15:30:29" itemprop="dateCreated datePublished" datetime="2022-10-08T14:46:38+08:00">2022-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unreal-engine/" itemprop="url" rel="index"><span itemprop="name">unreal engine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="角色在目标点生成"><a href="#角色在目标点生成" class="headerlink" title="角色在目标点生成"></a>角色在目标点生成</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>在关卡蓝图中弄一个怪物生成点，再调用上一节的<code>GameState</code>中的<code>SpawnMonster</code>以及<code>SpawnTower</code>函数即可</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="TargetPoint"><a href="#TargetPoint" class="headerlink" title="TargetPoint"></a>TargetPoint</h3><p>这是一个C++类型类型，用于设置自动生成怪物的位置（类似于MC里面的刷怪笼）</p>
<h2 id="大致步骤"><a href="#大致步骤" class="headerlink" title="大致步骤"></a>大致步骤</h2><ol>
<li><p>创建<code>TargetPoint</code>类型的C++文件<code>SpawnPonit</code></p>
</li>
<li><p>重新配置数据表，在<code>Content/GameData/MonstersDataTable</code>中配置生成怪物的各项属性，同路径下的塔数据同理</p>
</li>
<li><p>在关卡蓝图中使用蓝图逻辑生成怪物</p>
<ul>
<li><p>在关卡蓝图中<code>获取游戏状态</code>，通过<code>Cast To</code>类型转换为我们自己定义的<code>TowerDefenceGameState</code></p>
</li>
<li><p>通过<code>TowerDefenceGameState</code>调用上一节中定义的函数<code>SpawnMonster</code>以及<code>SpawnTowers</code></p>
</li>
<li><p>在关卡中放置<code>SpawnPonit</code>，然后在关卡蓝图中获取其实例，将其<code>Loction</code>以及<code>Rotation</code>信息传入函数<code>SpawnMonster</code>以及<code>SpawnTowers</code>中</p>
</li>
<li><p>注意：将函数参数设置为Const类型，在蓝图中则表现为输入值</p>
</li>
</ul>
</li>
</ol>
<p><img src="/UE4-%E9%A1%B9%E7%9B%AE-TowerDefence-%E8%A7%92%E8%89%B2%E7%94%9F%E6%88%90%5C1.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/06/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/06/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86/" class="post-title-link" itemprop="url">UE4-C++-框架梳理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-06 14:30:44 / 修改时间：14:41:59" itemprop="dateCreated datePublished" datetime="2022-10-06T14:30:44+08:00">2022-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/unreal-engine/" itemprop="url" rel="index"><span itemprop="name">unreal engine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>UE 网络同步和框架</p>
<p>为一个UE引擎的初学者基于现有知识储备和见识的限制下，对UE网络和游戏框架的粗鄙之见，文中多有错误敬请指出以较后文。</p>
<h3 id="1-网络复制"><a href="#1-网络复制" class="headerlink" title="1.网络复制"></a>1.网络复制</h3><p>​ <strong>不论是服务端还是客户端，代码都是一样的，客户端和服务端拥有相同的变量和函数，只是有的函数可能只在服务端执行，有的变量可能只在某个客户端发生变化。</strong></p>
<p>​ 在多人网络游戏中，可以看到来自不同的玩家在同一个场UE 网络同步和框架</p>
<p>为一个UE引擎的初学者基于现有知识储备和见识的限制下，对UE网络和游戏框架的粗鄙之见，文中多有错误敬请指出以较后文。</p>
<h3 id="1-网络复制-1"><a href="#1-网络复制-1" class="headerlink" title="1.网络复制"></a>1.网络复制</h3><p>​ <strong>不论是服务端还是客户端，代码都是一样的，客户端和服务端拥有相同的变量和函数，只是有的函数可能只在服务端执行，有的变量可能只在某个客户端发生变化。</strong></p>
<p>​ 在多人网络游戏中，可以看到来自不同的玩家在同一个场景中，操作各自的武器或者道具，在游戏场景中进行各种交互。那么这里产生了一个问题，举例即，玩家A对玩家B使用了一个增益道具，玩家B是怎么知道自己获得了增益，并且让所有的玩家都知道自己获得了增益效果。这个问题的答案即在UE中非常重要的概念，网络复制。</p>
<h4 id="1-Replication（复制）"><a href="#1-Replication（复制）" class="headerlink" title="1.Replication（复制）"></a>1.Replication（复制）</h4><p>笼统的说，表示信息从服务端同步到客户端(单向),<strong>Actor及其派生类才有Replication的能力。</strong>一般分三种</p>
<h5 id="1-Actor-Replication-Actor复制"><a href="#1-Actor-Replication-Actor复制" class="headerlink" title="1.Actor Replication(Actor复制)"></a>1.Actor Replication(Actor复制)</h5><p>服务端生成，客户端也会跟着生成（在服务端生成一个Replicate对象）</p>
<p><strong>是当前Actor的所有属性复制，组件复制,RPC的总开关</strong></p>
<p>举上面的例子来说，如果在服务端生成了一个道具，但是这个道具并未开启或标记为Replication，那么这个道具只会出现在服务端的游戏场景里，而不会在客户端的游戏场景里生成，</p>
<p>具体用法：</p>
<p>蓝图：Actor细节面板中寻找复制相关的选项并勾选<strong>复制</strong>(Replicate)这一个选项即可，其他选项按需勾选</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5Cimage-20221004175454361.png" alt="image20221004175454361"></p>
<p>C++：在类的<strong>构造函数</strong>中添加</p>
<p><code>bReplicates = true;//开启网络复制</code></p>
<p>注意编译后若<strong>没有达到预期效果可以回到蓝图检查</strong>一下，C++中的设置仅相当于设置了默认项，有时候蓝图不一定使用C++中的默认值，需要查看并手动设置</p>
<p>需要<strong>注意</strong>的是：</p>
<p>若一个Actor没开启网络复制，那么物体只会在服务端生成，不会在客户端生成，此时客户端的角色或其他物体，如果企图穿越该Actor的位置(尽管在客户端上看不到也真的压根不存在这个东西)，则会发现移动被阻挡并发生鬼畜效果。这是因为在联机游戏中，物体的<strong>移动是在服务端上计算的</strong>，这是为了防止客户端作弊。试想，若是客户端有权限决定游戏的每一个属性值，那么只需要一个简单的CE修改器就能修改游戏内存，并称霸整个游戏服务器。因此，需要一个权威服务器(Authority)进行所有敏感信息的计算和验证,此时客户端上不存在该物体，而服务端上认为有，因此客户端上的角色在穿越该区域的时候，服务端认为客户端正在穿越一个被阻挡的区域，从而不断发出信息纠正客户端角色的位置，这时客户端上的角色，就会发现自己前进一小段距离后，立马瞬移一小段距离回去，一直按前进键就会导致鬼畜，这是被服务端的纠错影响的结果。</p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Up4y1x7KU">https://www.bilibili.com/video/BV1Up4y1x7KU</a></p>
<h5 id="2-Property-Replication-属性复制"><a href="#2-Property-Replication-属性复制" class="headerlink" title="2.Property Replication(属性复制)"></a>2.Property Replication(属性复制)</h5><p>某个具体属性的网络复制，比如玩家的血量，某个道具的数量等。举一个例子，服务端和客户端A上的玩家初始生命值都是100，这时服务端玩家拾取到了一个群体增益效果所有人加生命值100，若此时未开启生命值的属性复制，产生的结果是，仅服务端玩家的生命值增加了100，而客户端玩家的生命值未发生变化，这是因为服务端没能向客户端同步这个属性的信息。</p>
<p>这里产生一个问题，前面提到过可以将类作为一个整体进行网络复制，为什么还要单独设置属性赋值呢，直接将整个类复制岂不是更方便。这是因为在多人游戏中，<strong>网络传输信息会产生延迟</strong>，大量的信息传输容易更导致网络拥堵，同时在虚幻中<strong>网络信息传输拥有优先级</strong>，像被标记为<strong>Reliable的函数</strong>传输的优先级就会比被标记为<strong>Unreliable的函数</strong>更高(后面会说)，在网络状况不好的情况下，服务端会确保更重要的信息率先发出，不那么重要的信息丢了就丢了，比如子弹的命中通知就比特效的播放通知更重要优先级更高。因此属性复制时经常使用并且重要的。</p>
<p>具体用法：</p>
<p>蓝图：</p>
<p>在蓝图中选择一个属性变量并寻找replication并选择为Replicated</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5Cimage-20221004210425968.png" alt="image20221004210425968"></p>
<p>C++：</p>
<p>记得先在类的构造里面把bReplicate&#x3D;true这个总开关开了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(Replicated)<span class="comment">//使用属性网络复制，需要使用GetLifetimeReplicatedProps进行注册</span></span><br><span class="line"><span class="type">bool</span> bAiming;<span class="comment">//武器是否要瞄准</span></span><br></pre></td></tr></table></figure>

<p>首先在头文件中声明要使用网络复制的变量，比如这里设置一个武器是否瞄准的变量，并在上面添加UPROPERTY(Replicated)宏。随后在cpp文件中重写GetLifetimeReplicatedProps函数进行属性注册，函数格式如下。</p>
<p>.h文件中</p>
<p><code>virtual void GetLifetimeReplicatedProps(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps) const override;</code></p>
<p><code>//使用属性网络复制，需要使用此函数进行注册</code></p>
<p>.cpp文件中需要添加头文件#include”Net&#x2F;UnrealNetwork.h”</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UCombatComponent::GetLifetimeReplicatedProps</span><span class="params">(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    Super::<span class="built_in">GetLifetimeReplicatedProps</span>(OutLifetimeProps);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DOREPLIFETIME</span>(UCombatComponent, bAiming);<span class="comment">//注册CombatComponent类中声明的bool类型的bAiming变量，即类名称和变量名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样来设置属性复制</p>
<p>参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1tf4y1k7xc/">https://www.bilibili.com/video/BV1tf4y1k7xc/</a></p>
<h5 id="3-RepNotify-复制通知"><a href="#3-RepNotify-复制通知" class="headerlink" title="3.RepNotify(复制通知)"></a>3.RepNotify(复制通知)</h5><p>如果一个变量被设置为Rep_Notify，当改变量发生改变时自动响应，这时服务端和收到该值的客户端都可以自动触发一个自定义的函数，用于通知某个事件的发生。C++的版本略有区别，仅在客户端调用函数，服务端的通知需要手动写一个函数来通知。</p>
<p>蓝图不会没用过</p>
<p>C++：</p>
<p>记得先在类的构造里面把bReplicate&#x3D;true这个总开关开了</p>
<p>.h中声明</p>
<p><code>UPROPERTY(Replicated, ReplicatedUsing = OnRep_EquippedWeapon)//使用属性网络复制，需要使用GetLifetimeReplicatedProps进行注册</code></p>
<p>ReplicatedUsing后面跟要调用的自定义函数，一般用OnRep_作为格式的开头，而后书写自定义函数的声明</p>
<p><code>UFUNCTION() void OnRep_EquippedWeapon();//装备武器的Rep_Notify</code></p>
<p>同时.cpp中也要加入GetLifetimeReplicatedProps()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void UCombatComponent::GetLifetimeReplicatedProps(TArray&lt;FLifetimeProperty&gt;&amp; OutLifetimeProps) const</span><br><span class="line">&#123;</span><br><span class="line">Super::GetLifetimeReplicatedProps(OutLifetimeProps);</span><br><span class="line">DOREPLIFETIME(UCombatComponent, EquippedWeapon);//注册</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>视频参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ht4y1z79w">https://www.bilibili.com/video/BV1ht4y1z79w</a></p>
<h4 id="2-OnwerShip-所有权"><a href="#2-OnwerShip-所有权" class="headerlink" title="2.OnwerShip(所有权)"></a>2.OnwerShip(所有权)</h4><p>理论概念，就是说很多类或者Actor在游戏中会伴随拥有者的改变而改变自己的所有权，比如在地上的枪，纵使被设置为Replicate，无人拾取的话，那么其所有权属于世界，而不是玩家，因此这把武器的信息不会被同步到任何一个玩家身上，但是当一名玩家拾取这把武器的时候，所有权被更改到这个玩家身上，这时这把枪的信息被添加到了玩家身上，玩家多出了一把武器，这把属于这名玩家的武器在击杀敌人后，因为枪的所有权是属于玩家的，所以分数算在了玩家身上。我的枪杀了你，不是我杀了你。</p>
<p>因此玩家死亡后，武器掉落，这把武器的所有权重新回归世界，而不是任一一名玩家，直到下一个玩家的到来。</p>
<p>视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1T44y1k72n">https://www.bilibili.com/video/BV1T44y1k72n</a></p>
<h4 id="3-Actor-Role"><a href="#3-Actor-Role" class="headerlink" title="3.Actor Role"></a>3.Actor Role</h4><p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5C%E8%87%AA%E4%B8%BB%E6%9D%83%E5%A8%81%E6%A8%A1%E6%8B%9F.png" alt="自主权威模拟"></p>
<p>服务端拥有所有玩家的权威实例，所有的信息必须经过服务器的确认才能生效。称为Authority；</p>
<p>客户端拥有自己的自主代理和所有其他玩家的模拟代理，自主代理就是本机控制的玩家，模拟代理就是画面上其他的玩家。区别如下：</p>
<p>Autonomous Proxy自主代理拥有此玩家的控制权，键盘键盘输入的信息直接操作自主代理，之所以称作代理，是因为虽然能控制你的角色，但实际上你角色的所有信息和操作必须经过服务端的计算和确认，才能真正的生效。此处产生一个问题，经过服务端的计算和确认再生效的话，来回会使得延迟很高，为了解决这个问题，自主代理会直接根据你的输入在本地进行计算并输调用事件和产生对应的画面，而信息则发到服务端进行确认，若是结果不一致，则服务端发回信息进行纠正，若一致，自主代理这边已经执行好了，最大幅度提升了玩家的体验感。这涉及到复杂的确认关系，不在讨论范围内。<strong>客户端内除了自己剩下所有玩家的Character都是模拟代理的，所以网络不好的时候，会发现自己经常瞬移。你按下前进键的时候，服务端发送回来的位置信息没有被接收到，你向前位移了一点，这是本地自主代理做出的，但是很快本地意识到，没有接收到服务端发送回来的确认位置的信息，于是本地判断你还在原地，因此你的画面卡在了原地。注意此时服务端已经因为你之前按下的前进键而更新了你的位置信息，此时若网络恢复正常，服务端再次发送回的位置信息就和本地的不一致，因为服务端的信息具有权威性，本地的角色信息被强制更新改变，然后就发生了瞬移，不过更多的情况是闪现移坟(在你掉线的时候你已经被其他玩家杀了)，换了个躺尸体的地方而已。</strong></p>
<p>Simulated Proxy模拟代理是客户端根据服务端发送来的信息，在客户端上模拟出来的除自己外的所有玩家，你所有对其他玩家的操作，都是在对从服务端发来的信息进行的操作。即，服务器认为其他的玩家在哪在干什么，你的客户端上模拟出来的玩家就在哪在干什么。客户端内除了自己剩下所有玩家的Character都是模拟代理的。</p>
<p>Authority权威，在监听服务器模式下，服务端就是权威，服务端拥有所有玩家的权威信息，包括自己，其他客户端上所有的信息都是从权威服务端复制出去的，<strong>权威服务端上拥有所有真正的玩家实例，因此在服务端上的操作拥有最低的延迟</strong>，因为不需要找服务端确认计算是否正确是否被篡改了，所有信息以服务端为准。</p>
<h4 id="4-RPC远程过程调用-Remote-Progress-Call"><a href="#4-RPC远程过程调用-Remote-Progress-Call" class="headerlink" title="4.RPC远程过程调用(Remote Progress Call)"></a>4.RPC远程过程调用(Remote Progress Call)</h4><p>可以实现客户端调用服务端执行，也可以实现服务端调用客户端执行。因为异步，所以不可以有返回值，默认是不可靠的，若要设置为可靠，UPROPERTY里设置为Reliable，RPC一共有四种状态，<strong>未复制、NetMultiCast、Server、Client</strong></p>
<p>参考图：</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5Cimage-20221005133737857.png" alt="image20221005133737857"></p>
<p><strong>图片解释：</strong></p>
<p>如果是从服务端调用了RPC，<strong>一般情况下</strong>，对于UPRPERTY标记为NetMulticast的，即网络多播，这个函数会在<strong>服务端和所有的客户端上都执行一次</strong>。标记为Server的，那么这个函数<strong>仅在服务端上执行</strong>。标记为Client的，则<strong>在所有的客户端上执行，但是服务端不执行</strong>。<strong>特殊情况是Actor的所有权不属于客户端，而属于服务端或者谁也不属于</strong>，这种情况结果参照上图。</p>
<p>如果是从客户端调用了RPC，<strong>所有情况下</strong>，对UPRPERTY标记为NetMulticast的，仅在本地执行。标记为Server的，会在服务器上运行，这也是唯一一种客户端调用服务端的函数的方式。标记为Client的，仅在本地执行。<strong>特殊情况是若函数要操作的Actor所有权不属于本地客户端，此时函数UPROPERTY若被标记为Server，即请求服务端执行函数调用，那么服务端会丢弃这样的请求不做处理</strong>，可参照上图。</p>
<p>实现方式：</p>
<p>蓝图：</p>
<p>CustomEvent事件的Replicates选项设置有Run On Server，Run On Owing Client，Net MultiCast中的一个。</p>
<p>C++：</p>
<p>在函数生命中添加Server、Client、Net MultiCast关键字添加到UFUNCTION声明中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UFUNCTION(Server, Reliable)                                                                                                     void ServerFire();//仅在服务器开火 </span><br><span class="line"></span><br><span class="line">UFUNCTION(NetMulticast,  Reliable)</span><br><span class="line">void MultiCastFire();//从服务器发起的通知所有客户端开火</span><br><span class="line"></span><br><span class="line">UFUNCTION(Client,  Reliable)</span><br><span class="line">void ClientFire();//服务器发起的向客户端的多播开火</span><br></pre></td></tr></table></figure>

<p>视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1R34y1Q7b6">https://www.bilibili.com/video/BV1R34y1Q7b6</a></p>
<h3 id="2-监听服务器模式下的状态关系"><a href="#2-监听服务器模式下的状态关系" class="headerlink" title="2.监听服务器模式下的状态关系"></a>2.监听服务器模式下的状态关系</h3><h4 id="1-各个大类的功用介绍"><a href="#1-各个大类的功用介绍" class="headerlink" title="1.各个大类的功用介绍"></a>1.各个大类的功用介绍</h4><p>至于这些状态的功能有个举例图：</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5C%E6%B8%B8%E6%88%8F%E6%A8%A1%E5%BC%8F%E6%B8%B8%E6%88%8F%E7%8A%B6%E6%80%81%E7%8E%A9%E5%AE%B6%E7%8A%B6%E6%80%81.png" alt="游戏模式游戏状态玩家状态"></p>
<p>还有个玩家控制器就不单独放图了。玩家控制器可以设置用户控件，比如播放比赛的消息，更新玩家血量条，更新分数，更新击杀死亡数量信息，以及更新弹药。</p>
<p>看出游戏模式类中包括了玩家控制器和用户界面类，以及游戏的具体规则和匹配状态。</p>
<h5 id="1-GameMode"><a href="#1-GameMode" class="headerlink" title="1.GameMode"></a>1.GameMode</h5><p>两个主要类负责处理进行中游戏的相关信息：<strong>Game Mode</strong> 和 <strong>Game State</strong>。游戏模式是针对当前关卡的设定，里面<strong>存储了当前关卡的规则和玩法</strong>，即使最开放的游戏也拥有基础规则，而这些规则构成了 <strong>Game Mode</strong>。比如得分达到一定数目后某方获胜，然后播放什么样的动画，调用什么样的函数进行结算，再跳转到什么地图。诸如此类。在游戏模式中设置pawn类，HUD类，玩家控制器，游戏状态和玩家状态。</p>
<h5 id="2-GameState"><a href="#2-GameState" class="headerlink" title="2.GameState"></a>2.GameState</h5><p>游戏状态类主要是<strong>当前对局的具体信息</strong>，基于规则的事件在游戏中发生，需要进行追踪并和所有玩家共享时，信息将通过 <strong>Game State</strong> 进行存储和同步。例如</p>
<ul>
<li><p>游戏已运行的时间（包括本地玩家加入前的运行时间）。</p>
</li>
<li><p>每个个体玩家加入游戏的时间和玩家的当前状态，MVP玩家的信息等</p>
</li>
<li><p>当前 Game Mode 的基类。</p>
</li>
<li><p>游戏是否已开始，正在匹配中，游戏正在结算，游戏正在热身时间等</p>
</li>
<li><p>分数领先的队伍信息，队伍的分数信息以及玩家所属的队伍信息。</p>
</li>
</ul>
<h5 id="3-PlayerController"><a href="#3-PlayerController" class="headerlink" title="3.PlayerController"></a>3.PlayerController</h5><p>玩家控制器是Actor的一种子类型，其负责控制玩家所使用的的Pawn&#x2F;Character。<strong>控制器（Controller）</strong> 是一种可以控制Pawn（或Pawn的派生类，例如角色（Character）），从而控制其动作的非实体Actor。人类玩家使用PlayerController控制Pawn，而AIController则对它们控制的Pawn实加人工智能效果。控制器用Possess函数控制Pawn，用Unpossess函数放弃控制Pawn。</p>
<p><strong>控制器会接收其控制的Pawn所发生诸多事件的通知。因此控制器可借机实现 响应此事件的行为，拦截事件并接替Pawn的默认行为。 可以让控制器在给定的Pawn之前运行， 从而从而最大限度减少输入处理与Pawn移动之间的延迟。比如把响应事件写在按键的响应上而不是用具体Pawn类去响应事件。</strong></p>
<p>默认情况下，控制器与Pawn之间存在一对一的关系；也就是说，每个控制器在任何给定的时间只控制一个Pawn。这对于大多数 类型的游戏都是可以接受的，但对于某些类型的游戏可能需要进行调整，因为实时策略可能需要能够同时控制多个实体。</p>
<h5 id="4-AIController"><a href="#4-AIController" class="headerlink" title="4.AIController"></a>4.AIController</h5><p><strong>玩家控制器（PlayerController）</strong> 主要依靠人类玩家来制定决策，而 <strong>AI控制器（AIController）</strong> 则侧重通过场景中的信息来做出响应。AI控制器的任务<strong>是观察周遭的世界，相应作出决策，无需人类玩家的控制。</strong></p>
<h5 id="5-Actor"><a href="#5-Actor" class="headerlink" title="5.Actor"></a>5.Actor</h5><p>Actor是一种可以在世界中放置的的对象，可静态可动态，比如到处走动的玩家，巡逻的敌人，可拾取的道具和金币，可移动的场景电梯、轮船，<strong>一切实物都是Actor。</strong></p>
<h5 id="5-ActorComponent"><a href="#5-ActorComponent" class="headerlink" title="5.ActorComponent"></a>5.ActorComponent</h5><p>ActorComponent是一种可复用的组件，能被附加到任意的Actor上，Actor可以将组件作为子对象附加到自身。组件适用于共享相同的行为，例如显示视觉表现、播放声音。它们还可以表示项目特有的概念，例如载具解译输入和改变其速度与方向的方式。<strong>举例而言，某个项目拥有用户可控制车辆、飞机和船只。可以通过更改载具Actor所使用的组件，来实现载具控制和移动的差异。</strong></p>
<h5 id="6-PlayerState"><a href="#6-PlayerState" class="headerlink" title="6.PlayerState"></a>6.PlayerState</h5><p>玩家状态类则是包含了<strong>具体玩家的各种信息</strong>，不仅限于分数，击杀数，弹药量和所属队伍，也可以包括技能冷却信息，天赋激活信息和道具使用信息。</p>
<h5 id="7-GameInstance"><a href="#7-GameInstance" class="headerlink" title="7.GameInstance"></a>7.GameInstance</h5><p><strong>游戏实例中存储了当前对局中的所有变量，游戏实例随游戏的打开而创建，随游戏的关闭而销毁，</strong>例如游戏中切换了地图，那么游戏实例之前保存的是上一张地图的信息，现在则变成成了最新的地图信息，起到一个临时的保存和效果。</p>
<h5 id="8-Pawn-x2F-Character"><a href="#8-Pawn-x2F-Character" class="headerlink" title="8.Pawn&#x2F;Character"></a>8.Pawn&#x2F;Character</h5><p>Character角色类一般用于<strong>人形目标</strong>的实现，比如玩家类，人形的敌人类，人形NPC或者BOSS此种，类中<strong>内设了Character Movement角色移动类组件</strong>，可以让用户快速的设置人形目标的各种移动效果，诸如下蹲移动速度，奔跑速度，奔跑最大速度，奔跑加速度甚至游泳状态，反正就是一切人形目标的移动属性都几乎内设在这个类中供用户设置。需要注意的是，Character是Pawn的一种类型，即<strong>是Pawn的一种继承</strong>，增加了可四处走动的功能。</p>
<p>Pawn和Character类很像，区别在于<strong>Pawn类一般用于非人形目标</strong>，比如你操控的是一台机关，放置在墙壁上或者高台上，这个机关不具有人形，但是却有和Character类差不多的操作和功能，比如射击，使用道具和获取奖励等，那么这个时候一般选用Pawn类，比如你操控的是一台靠轮子走的坦克，汽车，甚至飞机，机甲，哥斯拉和恐龙，这些单位从功能上来说和Character角色类很像，但是可能有不一样的移动方式，比如飞行或者爬墙，这个时候其<strong>移动组件通常需要玩家自己编写</strong>，当然如果是放置类的单位就不需要，比如一个具有加工功能的桌子，放那能用能加工不就行了，谁写移动功能啊，觉得碍眼的时候销毁一下就行；那么这些情况下我们通常使用Pawn类作为基类进行编写。</p>
<p>放一张小关系图</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5Cimage-20221004141737070.png" alt="image20221004141737070"></p>
<p>2.GameMode实现(<strong>重要</strong>)</p>
<p>进行游戏所需要的玩家数量，或玩家加入游戏的方法，在多种类型的游戏中具有共通性。无论规则如何，Game Modes 的任务都是定义和实现规则。Game Modes 当前常用的基类有两个。</p>
<p>4.14 版本中加入了 <code>AGameModeBase</code>，这是所有 Game Mode 的基类，是经典的 <code>AGameMode</code> 简化版本。<code>AGameMode</code> 是 4.14 版本之前的基类，仍然保留，功能 如旧，但现在是 <code>AGameModeBase</code> 的子类。由于其比赛状态概念的实现，**<code>AGameMode</code> 更适用于标准游戏类型（如多人射击游戏）**。<code>AGameModeBase</code> 简洁高效，是新代码项目中包含的全新默认游戏模式。</p>
<h6 id="1-AGameModeBase"><a href="#1-AGameModeBase" class="headerlink" title="1.AGameModeBase"></a>1.AGameModeBase</h6><p>所有 Game Mode 均为 <code>AGameModeBase</code> 的子类。而 <code>AGameModeBase</code> 包含大量可覆盖的基础功能。部分常见函数包括：</p>
<table>
<thead>
<tr>
<th>函数&#x2F;事件</th>
<th>目的</th>
</tr>
</thead>
<tbody><tr>
<td><code>InitGame</code>初始化游戏</td>
<td><code>InitGame</code> 事件在其他脚本之前调用（包括 <code>PreInitializeComponents</code>），<code>AGameModeBase::PreInitializeComponents</code>预初始化控件</td>
</tr>
<tr>
<td><code>PreLogin</code>准备加入</td>
<td>接受或拒绝尝试加入服务器的玩家。如它将 <code>ErrorMessage</code> 设为一个非空字符串，会导致 <code>Login</code> 函数失败。<code>PreLogin</code> 在 <code>Login</code> 前调用，Login 调用前可能需要大量时间，加入的玩家需要下载游戏内容时尤其如此。</td>
</tr>
<tr>
<td><code>PostLogin</code>请求加入</td>
<td>成功登录后调用。在 <code>PlayerController</code> 上调用可网络复制函数是安全的。<code>OnPostLogin</code> 可在蓝图中实现，以添加额外的逻辑。</td>
</tr>
<tr>
<td><code>HandleStartingNewPlayer</code>新玩家生成</td>
<td>在 <code>PostLogin</code> 后或无缝游历后调用，可在蓝图中覆盖，修改新玩家身上发生的事件。它将默认创建一个玩家 pawn。</td>
</tr>
<tr>
<td><code>RestartPlayer</code>重启&#x2F;复活玩家</td>
<td>调用开始生成一个玩家 pawn。如需要指定 Pawn 生成的地点，还可使用 <code>RestartPlayerAtPlayerStart</code> 和 <code>RestartPlayerAtTransform</code> 函数。<code>OnRestartPlayer</code> 可在蓝图中实现，在此函数完成后添加逻辑。</td>
</tr>
<tr>
<td><code>SpawnDefaultPawnAtTransform</code>在指定位置生成Pawn</td>
<td>这实际生成玩家 Pawn，可在蓝图中覆盖。</td>
</tr>
<tr>
<td><code>Logout</code>退出游戏</td>
<td>玩家离开游戏或被摧毁时调用。可实现 <code>OnLogout</code> 执行蓝图逻辑。</td>
</tr>
</tbody></table>
<p>可针对游戏提供的每个比赛格式、任务类型或特殊区域创建 <code>AGameModeBase</code> 的子类。一款游戏可拥有任意数量的 Game Mode，因此也可拥有任意数量的 <code>AGameModeBase</code> 类子类；然而，给定时间上只能使用一个 Game Mode。每次关卡进行游戏实例化时 Game Mode Actor 将通过 <code>UGameEngine::LoadMap()</code> 函数进行实例化。</p>
<p>Game Mode 不会复制到加入多人游戏的远程客户端；它只存在于服务器上，因此本地客户端可看到之前使用过的留存 Game Mode 类（或蓝图）；但无法访问实际的实例并检查其变量，确定游戏进程中已发生哪些变化。如玩家确实需要更新与当前 Game Mode 相关的信息，可将信息保存在一个 <code>AGameStateBase</code> Actor 上，轻松保持同步。<code>AGameStateBase</code> Actor 随 Game Mode 而创建，之后被复制到所有远程客户端。注意，<strong>GameStateBase由GameModeBase生成。</strong></p>
<h6 id="2-AGameMode"><a href="#2-AGameMode" class="headerlink" title="2.AGameMode"></a>2.AGameMode</h6><p><code>AGameMode</code> 是 <code>AGameModeBase</code> 的子类，拥有一些额外的功能支持多人游戏和旧行为。所有新建项目默认使用 <code>AGameModeBase</code>。如果需要此额外行为，可切换到从 <code>AGameMode</code> 进行继承。如从 <code>AGameMode</code> 进行继承，也可从 <code>AGameState</code> 继承游戏状态（其支持比赛状态机）。</p>
<p><code>AGameMode</code> 包含一个跟踪比赛状态或整体游戏流程的状态机。可使用 <code>GetMatchState</code> 或 <code>HasMatchStarted</code>、<code>IsMatchInProgress</code> 和 <code>HasMatchEnded</code> 之类的封装器查询当前的状态。以下是可能的比赛状态：</p>
<ul>
<li><code>EnteringMap</code> 是<strong>初始状态</strong>。Actor 尚未进行 tick，世界场景尚未完整初始化。内容完整加载后将过渡到下个状态。</li>
<li><code>WaitingToStart</code> 是下个状态，进入时将调用 <code>HandleMatchIsWaitingToStart</code>。Actor 正在进行 tick，但玩家尚未生成。如 <code>ReadyToStartMatch</code> 返回 <em>true</em> 或 <code>StartMatch</code> 被调用，它将过渡到下个状态。</li>
<li><code>InProgress</code> 是游戏主体所发生的状态。进入此状态时将调用 <code>HandleMatchHasStarted</code>，然后在所有 Actor 上调用 <code>BeginPlay</code>。此时，正常游戏进程已在进行中。<code>ReadyToEndMatch</code> 返回 <em>true</em> 或调用 <code>EndMatch</code> 时比赛将过渡到下个状态。</li>
<li><code>WaitingPostMatch</code> 是倒数第二个状态，进入时将调用 <code>HandleMatchHasEnded</code>。Actor 仍在 tick，但新玩家无法加入。地图转换开始时它将过渡到下个状态。</li>
<li><code>LeavingMap</code> 是正常流程中的最后一个状态，进入时将调用 <code>HandleLeavingMap</code>。转换到新地图时比赛将保持在此状态中，进入新地图时将过渡回到 <code>EnteringMap</code>。</li>
<li><code>Aborted</code> 是失败状态，调用 <code>AbortMatch</code> 可开始此状态。出现无法恢复的错误时将进行此设置。</li>
</ul>
<p>游戏状态将固定为 <code>InProgress</code>，因为这是调用 <code>BeginPlay</code>、actor 开始 tick 的状态。然而，<strong>个体游戏可能覆盖这些状态</strong>的行为，用更复杂的规则构建一个多人游戏，如在一款多人射击游戏中等待其他玩家加入时允许玩家在关卡中自由飞行。</p>
<h6 id="3-Game-State"><a href="#3-Game-State" class="headerlink" title="3.Game State"></a>3.Game State</h6><p><strong>Game State</strong> 负责启用客户端监控游戏状态。从概念上而言，Game State 应该管理所有已连接客户端已知的信息（特定于 Game Mode 但不特定于任何个体玩家）。它能够追踪游戏层面的属性，如已连接玩家的列表、夺旗游戏中的团队得分、开放世界游戏中已完成的任务，等等。</p>
<p>Game State 并非追踪玩家特有内容（如夺旗比赛中特定玩家为团队获得的分数）的最佳之处，因为它们由 <strong>Player State</strong> 更清晰地处理。整体而言，GameState 应该追踪游戏进程中变化的属性。这些属性与所有人皆相关，且所有人可见。Game mode 只存在于服务器上，而 Game State 存在于服务器上且会被复制到所有客户端，保持所有已连接机器的游戏进程更新。</p>
<p><code>AGameStateBase</code> 是基础实现，其部分默认功能包括：</p>
<table>
<thead>
<tr>
<th>函数或变量</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td><code>GetServerWorldTimeSeconds</code></td>
<td>这是 <code>UWorld</code> 函数 <code>GetTimeSeconds</code> 的服务器版本，将在客户端和服务器上同步，因此该时间可用于复制，十分可靠。</td>
</tr>
<tr>
<td><code>PlayerArray</code></td>
<td>这是所有 <code>APlayerState</code> 对象的阵列，对游戏中所有玩家执行操作时十分实用。</td>
</tr>
<tr>
<td><code>HasBegunPlay</code></td>
<td>如 <code>BeginPlay</code> 函数在游戏中的 actor 上调用，则返回 true。</td>
</tr>
</tbody></table>
<p>下面是部分GameMode基类的函数，更多属性和函数请参考GameMode.h文件</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5CGameMode%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81.png" alt="GameMode部分源码"></p>
<p>3.各个类的生成数量</p>
<p>关于游戏模式、玩家控制器、Pawn、角色、游戏实例、游戏状态、玩家状态GameMode&#x2F;PlayerController&#x2F;Pawn&#x2F;Character&#x2F;GameInstance&#x2F;GameState&#x2F;PlayerState 6个类的生成情况和生成个数。</p>
<p>首先，PlayerController、GameMode、PlayerState、都需要在关卡的WorldSetting中的GameMode栏设置，因为这几个类的生命周期仅存在于关卡中，GameInstance类需要在Edit-&gt;project setting-&gt;Map&amp;Modes中最下面的GameInstance中设定。</p>
<table>
<thead>
<tr>
<th></th>
<th>生命周期</th>
<th>存在于</th>
<th>是否网络复制</th>
<th>进程内个数</th>
</tr>
</thead>
<tbody><tr>
<td>GameInstance</td>
<td>进程</td>
<td>服务器和客户端</td>
<td>否</td>
<td>1</td>
</tr>
<tr>
<td>GameMode</td>
<td>关卡</td>
<td>服务器</td>
<td>不适用</td>
<td>1</td>
</tr>
<tr>
<td>GameState</td>
<td>关卡</td>
<td>服务器和客户端</td>
<td>是</td>
<td>1</td>
</tr>
<tr>
<td>PlayerController</td>
<td>关卡</td>
<td>服务器和客户端</td>
<td>是</td>
<td>服务器上为玩家群体的总数量，客户端上只有一个</td>
</tr>
<tr>
<td>PlayerState</td>
<td>关卡</td>
<td>服务器和客户端</td>
<td>是</td>
<td>同玩家个数</td>
</tr>
<tr>
<td>Pawn&#x2F;Character</td>
<td>逻辑控制</td>
<td>服务器和客户端</td>
<td>是</td>
<td>同玩家个数</td>
</tr>
</tbody></table>
<p>此处的是否可复制表示服务器端的变化<strong>是否会复制到所有客户端</strong>，生命周期指的是不同生命周期类可以不一样，对于生命周期为关卡的类制定在每个关卡WorldSetting中的GameMode设置。</p>
<p>举例：</p>
<p>如果此时房间里有3个玩家，即两个客户端一个服务端，那么对应其生成情况如下：</p>
<table>
<thead>
<tr>
<th>Player&#x2F;Character</th>
<th>在服务器上生成3个，两个客户端上各自生成3个</th>
</tr>
</thead>
<tbody><tr>
<td>PlayerState</td>
<td>在服务器上生成3个，两个客户端上分别生成3个(世界场景中总共9个)</td>
</tr>
<tr>
<td>PlayerController</td>
<td>服务器上生成3个，两个客户端上分别生成1个(世界场景中总共5个)</td>
</tr>
<tr>
<td>GameMode</td>
<td>只在服务器上生成1个。客户端上不生产，只允许服务端拥有。</td>
</tr>
<tr>
<td>GameState</td>
<td>服务器上生成1个，两个客户端上分别生成1个。(世界场景中总共3个)</td>
</tr>
<tr>
<td>GameInstance</td>
<td>服务器上生成1个，两个客户端上各自生成1个。(整个世界场景中共生成3个)</td>
</tr>
<tr>
<td>关卡蓝图</td>
<td>服务器上生成1个，两个客户端上各自生成1个。(整个世界场景中共生成3个)</td>
</tr>
</tbody></table>
<p>这里有两张图便于数量和关系的理解</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5C%E6%95%B0%E9%87%8F%E7%90%86%E8%A7%A3.png" alt="数量理解"></p>
<p><strong>Game State</strong> 并非追踪玩家特有内容（如夺旗比赛中特定玩家为团队获得的分数）的最佳之处，因为它们由 <strong>Player State</strong> 更清晰地处理。整体而言，GameState 应该追踪游戏进程中变化的属性。这些属性与所有人皆相关，且所有人可见。<strong>Game mode 只存在于服务器上</strong>，而 Game State 存在于服务器上且<strong>会被复制到所有客户端</strong>，保持所有已连接机器的游戏进程更新。</p>
<p><img src="/UE4-C-%E6%A1%86%E6%9E%B6%E6%A2%B3%E7%90%86%5C%E7%B1%BB%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF.png" alt="类在服务端和客户端"></p>
<p>3.参考资料</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://space.bilibili.com/12825137/channel/seriesdetail?sid=317657">安宁Ken的个人空间_哔哩哔哩_Bilibili</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/5.0/zh-CN/game-mode-and-game-state-in-unreal-engine/">虚幻引擎中的 Game Mode 和 Game State | 虚幻引擎5.0文档</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/UE">https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/UE</a> 网络同步和框架</p>
</li>
<li><p>转载自我的好兄弟：<a href="mailto:&#50;&#54;&#x35;&#55;&#x33;&#52;&#56;&#54;&#x37;&#x39;&#64;&#113;&#113;&#46;&#x63;&#111;&#x6d;">&#50;&#54;&#x35;&#55;&#x33;&#52;&#56;&#54;&#x37;&#x39;&#64;&#113;&#113;&#46;&#x63;&#111;&#x6d;</a></p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/06/UDP%E7%AE%80%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/06/UDP%E7%AE%80%E8%BF%B0/" class="post-title-link" itemprop="url">UDP简述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-06 09:45:00 / 修改时间：10:48:18" itemprop="dateCreated datePublished" datetime="2022-10-06T09:45:00+08:00">2022-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">计算机网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>UDP协议全称是用户数据报协议，在网络中它与TCP协议一样用于处理数据包，是一种无连接的协议。在OSI模型中，在第四层——传输层，处于IP协议的上一层。UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。</p>
<h1 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h1><h2 id="面向无连接"><a href="#面向无连接" class="headerlink" title="面向无连接"></a>面向无连接</h2><p>首先 UDP 是不需要和 TCP一样在发送数据前进行三次握手建立连接的，想发数据就可以开始发送了。并且也只是数据报文的搬运工，不会对数据报文进行任何拆分和拼接操作。</p>
<p>具体来说就是：</p>
<p>在发送端，应用层将数据传递给传输层的 UDP 协议，UDP 只会给数据增加一个 UDP 头标识下是 UDP 协议，然后就传递给网络层了在接收端，网络层将数据传递给传输层，UDP 只去除 IP 报文头就传递给应用层，不会任何拼接操作</p>
<h2 id="有单播，多播，广播的功能"><a href="#有单播，多播，广播的功能" class="headerlink" title="有单播，多播，广播的功能"></a>有单播，多播，广播的功能</h2><p>UDP 不止支持一对一的传输方式，同样支持一对多，多对多，多对一的方式，也就是说 UDP 提供了单播，多播，广播的功能。</p>
<h2 id="UDP是面向报文的"><a href="#UDP是面向报文的" class="headerlink" title="UDP是面向报文的"></a>UDP是面向报文的</h2><p>发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。因此，应用程序必须选择合适大小的报文</p>
<h2 id="不可靠性"><a href="#不可靠性" class="headerlink" title="不可靠性"></a>不可靠性</h2><p>首先不可靠性体现在无连接上，通信都不需要建立连接，想发就发，这样的情况肯定不可靠。</p>
<p>并且收到什么数据就传递什么数据，并且也不会备份数据，发送数据也不会关心对方是否已经正确接收到数据了。</p>
<p>再者网络环境时好时坏，但是 UDP 因为没有拥塞控制，一直会以恒定的速度发送数据。即使网络条件不好，也不会对发送速率进行调整。这样实现的弊端就是在网络条件不好的情况下可能会导致丢包，但是优点也很明显，在某些实时性要求高的场景（比如电话会议）就需要使用 UDP 而不是 TCP。</p>
<h2 id="头部开销小，传输数据报文时是很高效的。"><a href="#头部开销小，传输数据报文时是很高效的。" class="headerlink" title="头部开销小，传输数据报文时是很高效的。"></a>头部开销小，传输数据报文时是很高效的。</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/06/TCP-IP%E7%AE%80%E8%BF%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="williny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Williny'home">
      <meta itemprop="description" content="孤独是人生的常态">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Williny'home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/06/TCP-IP%E7%AE%80%E8%BF%B0/" class="post-title-link" itemprop="url">TCP/IP简述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-06 09:32:36 / 修改时间：09:48:35" itemprop="dateCreated datePublished" datetime="2022-10-06T09:32:36+08:00">2022-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">计算机网络</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="TCP-x2F-IP-三次握手"><a href="#TCP-x2F-IP-三次握手" class="headerlink" title="TCP&#x2F;IP 三次握手"></a>TCP&#x2F;IP 三次握手</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>指在发送数据的准备阶段，需要先建立连接，（三次握手来建立连接）</p>
<h2 id="三次握手举例"><a href="#三次握手举例" class="headerlink" title="三次握手举例"></a>三次握手举例</h2><ol>
<li><p>就是A给B发送消息1 （A只知道自己刚刚发送了消息，但是发没发送成功，B有没有收到？A是不知道的，万一网络不好消息丢了呢或者B的协议不对，不能收到A的消息呢）</p>
</li>
<li><p>B给A发送消息2，告诉A,B刚刚收到了消息1，（此时，A给B发送消息，确认B是可以收到的A的消息，但是A有没有收到B的消息2，我们是不知道的，我们只是发出了消息，不确定收到消息没，万一消息2发丢了呢）</p>
</li>
<li><p>所以第三次，就是A再给B发送消息，告诉B,A可以收到B的消息。</p>
</li>
</ol>
<p>三次握手完成，双方确认了都可以收到对方消息，这就建立连接成功了</p>
<p><img src="https://img-blog.csdnimg.cn/d2415ebccb164e5294abc5b07bebeb22.png"></p>
<p>同步序号：SYN   确认字段：ACK  随机数据：seq</p>
<p>规定：</p>
<p>当SYN&#x3D;1,ACK&#x3D;0表示连接请求</p>
<p>当SYN&#x3D;1,ACK&#x3D;1表示同意建立连接</p>
<p>如上图，纵向的轴，是一个时间轴。</p>
<ol>
<li><p>第一次握手：时间点1，客户端向服务端发送连接请求报文段。ACK&#x3D;0,SYN&#x3D;1,seq&#x3D;x。将SYN位置为1，Sequence Number为x;然后，客户端进入SYN_SEND状态，等待服务器的确认;</p>
</li>
<li><p>第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1);同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y;服务器端将上述所有信息放到一个报文段(即SYN+ACK报文段)中，一并发送给客户端，此时服务器进入SYN_RECV状态;</p>
</li>
<li><p>第三次握手：客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。</p>
</li>
</ol>
<p>完成了三次握手，客户端和服务器端就可以开始传送数据。</p>
<h2 id="为什么是三次握手？而不是两次握手"><a href="#为什么是三次握手？而不是两次握手" class="headerlink" title="为什么是三次握手？而不是两次握手"></a>为什么是三次握手？而不是两次握手</h2><h3 id="原因1：-两次握手只能保证单向连接是畅通的。因为TCP是一个双向传输协议，只有经过第三次握手，才能确保双向都可以接收到对方的发送的数据。"><a href="#原因1：-两次握手只能保证单向连接是畅通的。因为TCP是一个双向传输协议，只有经过第三次握手，才能确保双向都可以接收到对方的发送的数据。" class="headerlink" title="原因1： 两次握手只能保证单向连接是畅通的。因为TCP是一个双向传输协议，只有经过第三次握手，才能确保双向都可以接收到对方的发送的数据。"></a>原因1： 两次握手只能保证单向连接是畅通的。因为TCP是一个双向传输协议，只有经过第三次握手，才能确保双向都可以接收到对方的发送的数据。</h3><p>接着上面的那个打电话的日常场景，如果是2次握手话，场景就是这样的。</p>
<p>你：你能听到我说话吗？</p>
<p>你朋友：我能听到你说话，你能听到我说话吗？</p>
<p>你：我能听到你说话</p>
<p>只是确认了对方能听到你说话，但是不能确认你能听到你朋友的说话。</p>
<p>如果两次握手，就正式谈话，如果你听不到你朋友的声音，这些你朋友给你说的话不就丢失了么。</p>
<p><img src="https://img-blog.csdnimg.cn/3fe9474a4dff416ebc9c7e7f42fd9daa.png"></p>
<h3 id="原因2：主要是为了防止已经失效的连接请求报文突然又传送到了服务器，从而导致不必要的错误和资源的浪费。"><a href="#原因2：主要是为了防止已经失效的连接请求报文突然又传送到了服务器，从而导致不必要的错误和资源的浪费。" class="headerlink" title="原因2：主要是为了防止已经失效的连接请求报文突然又传送到了服务器，从而导致不必要的错误和资源的浪费。"></a>原因2：主要是为了防止已经失效的连接请求报文突然又传送到了服务器，从而导致不必要的错误和资源的浪费。</h3><p>如果使用的是两次握手建立连接，假设有这样一种场景，客户端发送的第一个请求连接并且没有丢失，只是因为在网络中滞留的时间太长了，由于TCP的客户端迟迟没有收到确认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过两次握手完成连接，传输数据，然后关闭连接。此时之前滞留的那一次请求连接，因为网络通畅了, 到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再次建立连接，这将导致不必要的错误和资源的浪费。</p>
<p>如果采用的是三次握手，就算是那一次失效的报文传送过来了，服务端接受到了那条失效报文并且回复了确认报文，但是客户端不会再次发出确认。由于服务器收不到确认，就知道客户端并没有请求连接。<br><img src="https://img-blog.csdnimg.cn/d8d66b8e47e74089b94dfcb034ed9897.png"></p>
<h2 id="TCP建立连接为什么是三次握手，而不是四次？"><a href="#TCP建立连接为什么是三次握手，而不是四次？" class="headerlink" title="TCP建立连接为什么是三次握手，而不是四次？"></a>TCP建立连接为什么是三次握手，而不是四次？</h2><p>三次握手已经能说明握手时的通信是正常的，四次握手就显得浪费了。</p>
<h1 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h1><p>TCP 的连接的拆除需要发送四个包，因此称为四次挥手(Four-way handshake)，客户端或服务器均可主动发起挥手动作。</p>
<p>TCP连接是双向的，在四次挥手中，前两次挥手用于断开一个方向的连接，后两次挥手用于断开另一方向的连接。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/d33d52354d13a78d5f56e388033372a5.png"></p>
<p>1、第一次挥手</p>
<p> 客户端发送一个 FIN 报文（请求连接终止：FIN &#x3D; 1），报文中会指定一个序列号 seq &#x3D; u。并停止再发送数据，主动关闭 TCP 连接。此时客户端进入 FIN_WAIT_1 状态，等待服务端的确认。</p>
<p> FIN-WAIT-1 ：等待远程TCP的连接中断请求，或先前的连接中断请求的确认</p>
<p> FIN&#x3D;1表示该报文段是一个连接释放请求</p>
<p> seq&#x3D;u，u-1是客户端向服务端发送的最后一个字节的序号</p>
<p>2、第二次挥手</p>
<p>服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了，此时服务端进入 CLOSE_WAIT状态。</p>
<p> CLOSE_WAIT ：等待从本地用户发来的连接中断请求</p>
<p> ACK&#x3D;1：除TCP连接请求报文段以外，TCP通信过程中所有数据报的ACK都为1，表示应答</p>
<p> seq&#x3D;v，v是服务端释放应答报文段第一个字节序号</p>
<p> ack&#x3D;u+1表示希望收到从第u+1个字节开始的报文段，并且已经成功接收了前u个字节</p>
<p>第二次挥手完成后，客户端到服务端方向的连接已经释放，服务端不会再接收客户端的数据，客户端也没有数据要发送了。但服务端到客户端方向的连接仍然存在，服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个CLOSE-WAIT状态持续的时间。</p>
<p>3、第三次挥手</p>
<p>服务端将最后的数据发送完毕后，就向客户端发送连接释放报文，其报文头包含：FIN&#x3D;1，ack&#x3D;u+1，由于在CLOS-WAIT状态，服务端很可能又发送了一些数据，假定此时的序列号为seq&#x3D;w，此时，服务器进入LAST-ACK状态。</p>
<p>LAST_ACK : 等待原来发向远程TCP的连接中断请求的确认</p>
<p>4、第四次挥手</p>
<p>客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答（ack &#x3D; w+1），且把服务端的序列值 +1 作为自己 ACK 报文的序号值（seq&#x3D;u+1），此时客户端进入TIME_WAIT状态。</p>
<p> TIME_WAIT：等待足够的时间以确保远程TCP接收到连接中断请求的确认</p>
<p>该状态会持续2MSL（最长报文段寿命）时间，这个期间TCP连接还未释放，若该时间段内没有服务端的重发请求的话，客户端就进入CLOSED状态，撤销TCB。</p>
<p>服务端只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些。</p>
<h2 id="TCP关闭连接时为什么是四次挥手？"><a href="#TCP关闭连接时为什么是四次挥手？" class="headerlink" title="TCP关闭连接时为什么是四次挥手？"></a>TCP关闭连接时为什么是四次挥手？</h2><p>由于 TCP 的半关闭（half-close）特性，TCP 提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。</p>
<p> 任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就完全关闭了TCP连接。</p>
<h2 id="为什么TIME-WAIT状态需要经过2MSL才能返回到CLOSE状态？"><a href="#为什么TIME-WAIT状态需要经过2MSL才能返回到CLOSE状态？" class="headerlink" title="为什么TIME_WAIT状态需要经过2MSL才能返回到CLOSE状态？"></a>为什么TIME_WAIT状态需要经过2MSL才能返回到CLOSE状态？</h2><h3 id="1-为了保证服务端能收到客户端的确认应答。"><a href="#1-为了保证服务端能收到客户端的确认应答。" class="headerlink" title="1.为了保证服务端能收到客户端的确认应答。"></a>1.为了保证服务端能收到客户端的确认应答。</h3><p>若客户端发完确认应答后直接进入CLOSED状态，那么如果该应答丢失，服务端等待超时后就会重新发送连接释放请求，但此时客户端已经关闭了，不会作出任何响应，因此服务端就无法正常关闭。</p>
<h3 id="2-防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。"><a href="#2-防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。" class="headerlink" title="2.防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。"></a>2.防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。</h3><p> 客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样新的连接中不会出现旧连接的请求报文。</p>
<h1 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h1><h2 id="面向连接"><a href="#面向连接" class="headerlink" title="面向连接"></a>面向连接</h2><p>面向连接，是指发送数据之前必须在两端建立连接。建立连接的方法是“三次握手”，这样能建立可靠的连接。建立连接，是为数据的可靠传输打下了基础。</p>
<h2 id="仅支持单播传输"><a href="#仅支持单播传输" class="headerlink" title="仅支持单播传输"></a>仅支持单播传输</h2><p>每条TCP传输连接只能有两个端点，只能进行点对点的数据传输，不支持多播和广播传输方式。</p>
<h2 id="面向字节流"><a href="#面向字节流" class="headerlink" title="面向字节流"></a>面向字节流</h2><p>TCP不像UDP一样那样一个个报文独立地传输，而是在不保留报文边界的情况下以字节流方式进行传输。</p>
<h2 id="可靠传输"><a href="#可靠传输" class="headerlink" title="可靠传输"></a>可靠传输</h2><p>对于可靠传输，判断丢包，误码靠的是TCP的段编号以及确认号。TCP为了保证报文传输的可靠，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的字节发回一个相应的确认(ACK)；如果发送端实体在合理的往返时延(RTT)内未收到确认，那么对应的数据（假设丢失了）将会被重传。</p>
<h2 id="提供拥塞控制"><a href="#提供拥塞控制" class="headerlink" title="提供拥塞控制"></a>提供拥塞控制</h2><p>当网络出现拥塞的时候，TCP能够减小向网络注入数据的速率和数量，缓解拥塞</p>
<h2 id="TCP提供全双工通信"><a href="#TCP提供全双工通信" class="headerlink" title="TCP提供全双工通信"></a>TCP提供全双工通信</h2><p>TCP允许通信双方的应用程序在任何时候都能发送数据，因为TCP连接的两端都设有缓存，用来临时存放双向通信的数据。当然，TCP可以立即发送一个数据段，也可以缓存一段时间以便一次发送更多的数据段（最大的数据段大小取决于MSS）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">williny</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
